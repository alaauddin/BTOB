{% extends 'base.html' %}
{% load static %}
{% load cart_filters %}

{% block title %}{{ supplier.name }} | Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª{% endblock %}

{% block extra_meta %}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{{ supplier.name }} - ØªØ³ÙˆÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
    <meta property="og:description" content="{% if supplier.description %}{{ supplier.description }}{% else %}Ø§Ø³ØªÙƒØ´Ù ØªØ´ÙƒÙŠÙ„Ø© ÙˆØ§Ø³Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ø¯Ù‰ {{ supplier.name }}. ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù† Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±!{% endif %}">
    
    <meta itemprop="name" content="{{ supplier.name }} - ØªØ³ÙˆÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
    <meta itemprop="description" content="{% if supplier.description %}{{ supplier.description }}{% else %}Ø§Ø³ØªÙƒØ´Ù ØªØ´ÙƒÙŠÙ„Ø© ÙˆØ§Ø³Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ø¯Ù‰ {{ supplier.name }}. ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù† Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±!{% endif %}">

    {% with og_image=supplier.profile_picture|default:supplier.panal_picture %}
    {% if og_image %}
        {% if 'http' in og_image.url %}
        <meta property="og:image" content="{{ og_image.url }}">
        <meta property="og:image:secure_url" content="{{ og_image.url }}">
        <meta itemprop="image" content="{{ og_image.url }}">
        {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ og_image.url }}">
        <meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{{ og_image.url }}">
        <meta itemprop="image" content="{{ request.scheme }}://{{ request.get_host }}{{ og_image.url }}">
        {% endif %}
    {% elif system_settings.logo %}
        {% if 'http' in system_settings.logo.url %}
        <meta property="og:image" content="{{ system_settings.logo.url }}">
        <meta property="og:image:secure_url" content="{{ system_settings.logo.url }}">
        <meta itemprop="image" content="{{ system_settings.logo.url }}">
        {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ system_settings.logo.url }}">
        <meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{{ system_settings.logo.url }}">
        <meta itemprop="image" content="{{ request.scheme }}://{{ request.get_host }}{{ system_settings.logo.url }}">
        {% endif %}
    {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}">
        <meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}">
        <meta itemprop="image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}">
    {% endif %}
    {% endwith %}

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta property="twitter:title" content="{{ supplier.name }}">
    <meta property="twitter:description" content="{% if supplier.description %}{{ supplier.description }}{% else %}Ø§Ø³ØªÙƒØ´Ù ØªØ´ÙƒÙŠÙ„Ø© ÙˆØ§Ø³Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ø¯Ù‰ {{ supplier.name }}.{% endif %}">
    
    {% with twitter_image=supplier.profile_picture|default:supplier.panal_picture %}
    {% if twitter_image %}
        {% if 'http' in twitter_image.url %}
        <meta property="twitter:image" content="{{ twitter_image.url }}">
        {% else %}
        <meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ twitter_image.url }}">
        {% endif %}
    {% elif system_settings.logo %}
        {% if 'http' in system_settings.logo.url %}
        <meta property="twitter:image" content="{{ system_settings.logo.url }}">
        {% else %}
        <meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ system_settings.logo.url }}">
        {% endif %}
    {% else %}
        <meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}">
    {% endif %}
    {% endwith %}
{% endblock %}


{% block extra_css %}
<style>
    :root {
        --primary-base: {{ supplier.primary_color|default:'#F58231' }};
        --primary-bg-soft: {{ supplier.primary_color|default:'#F58231' }}0D;
        --primary-bg-medium: {{ supplier.primary_color|default:'#F58231' }}1A;
    }
</style>
<link rel="stylesheet" href="{% static 'css/product_list.css' %}?v={{ css_version }}">
{% endblock %}


{% block content %}
<div class="product-page-wrapper">
    
    <!-- 1. HERO SECTION -->
    {% if supplier_ads %}
    <div class="hero-wrapper">
        <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">
            <div class="carousel-indicators">
                {% for ad in supplier_ads %}
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                        class="{% if forloop.first %}active{% endif %}" aria-current="true"></button>
                {% endfor %}
            </div>
            
            <div class="carousel-inner">
                {% for ad in supplier_ads %}
                <div class="carousel-item hero-carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{ ad.image.url }}" class="hero-image" alt="{{ ad.title }}" loading="lazy">
                    
                    <!-- Text Overlay -->
                    <div class="hero-overlay">
                        <div class="hero-glass-badge">
                            {% if ad.title %}
                            <h2 class="h3 fw-bold mb-2">{{ ad.title }}</h2>
                            {% endif %}
                            
                            {% if ad.description %}
                            <p class="mb-3 opacity-90 small">{{ ad.description|truncatewords:15 }}</p>
                            {% endif %}
                            
                            {% if ad.product %}
                            <a href="{% url 'product_canonical' store_slug=supplier.store_id pk=ad.product.id %}" 
                               class="btn btn-sm btn-light rounded-pill px-4 fw-bold text-dark">
                                ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Store Header Fallback -->
    <div class="hero-wrapper" style="background: linear-gradient(135deg, var(--primary-bg-medium) 0%, var(--surface-1) 100%); padding: 3rem 1.5rem;">
        <div class="text-center animate-fade-in-up">
            {% if supplier.profile_picture %}
            <div class="mx-auto mb-3 p-1 bg-white rounded-circle shadow-sm" style="width: 90px; height: 90px;">
                <img src="{{ supplier.profile_picture.url }}" alt="{{ supplier.name }}" class="w-100 h-100 rounded-circle object-fit-cover">
            </div>
            {% endif %}
            <h1 class="fw-bold mb-1">{{ supplier.name }}</h1>
            <p class="text-muted small mb-0">{{ supplier.description|default:"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø±Ù†Ø§" }}</p>
        </div>
    </div>
    {% endif %}


    <!-- 2. CATEGORY NAVIGATION (Sticky) -->
    <div class="category-nav-wrapper">
        <div class="category-pills-container hide-scrollbar">
            <!-- All Products Link -->
            <a href="{% url 'store_home' supplier.store_id %}" 
               class="nav-pill-item {% if not active_category_id %}active{% endif %}">
                Ø§Ù„ÙƒÙ„
            </a>
            
            <!-- Dynamic Categories -->
            {% for category in categories %}
            <a href="#cat-{{ category.id }}" 
               class="nav-pill-item {% if active_category_id == category.id %}active{% endif %}"
               data-cat-toggle="{{ category.id }}">
                {{ category.name }}
            </a>
            {% endfor %}
        </div>
        
        <!-- Subcategories Drawers -->
        {% for category in categories %}
        <div id="cat-{{ category.id }}-subs" class="subcategory-bar {% if active_category_id == category.id %}show{% endif %}">
            <div class="d-flex flex-wrap gap-2">
                {% for subcategory in category.productcategory_set.all %}
                <a href="{% url 'store_subcategory' store_slug=supplier.store_id subcategory_id=subcategory.id %}" 
                   class="badge bg-white text-dark border p-2 text-decoration-none {% if active_subcategory_id == subcategory.id %}bg-light border-primary text-primary{% endif %}">
                    {{ subcategory.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>


    <!-- 3. MAIN CONTENT GRID -->
    <div class="container py-4">
        
        <!-- Offers / Featured -->
        {% if offer_products %}
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <span class="fs-4 me-2">ğŸ”¥</span>
                <h3 class="h5 fw-bold mb-0">Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>
            </div>
            
            <!-- Horizontal Scroll for Offers (Netflix Style) -->
            <div class="d-flex gap-3 overflow-auto hide-scrollbar pb-3" style="margin: 0 -1rem; padding: 0 1rem;">
                {% for product in offer_products %}
                <div style="min-width: 280px; width: 280px;">
                    {% include "product_card_snippet.html" with is_horizontal=True %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- New Arrivals -->
        {% if new_products %}
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <span class="fs-4 me-2">âœ¨</span>
                <h3 class="h5 fw-bold mb-0">ÙˆØµÙ„ Ø­Ø¯ÙŠØ«Ø§Ù‹</h3>
            </div>
            <div class="product-grid">
                {% for product in new_products %}
                    {% include "product_card_snippet.html" %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- All Products -->
        {% if other_products %}
        <div class="mb-5">
             <div class="d-flex align-items-center mb-3">
                <span class="fs-4 me-2">ğŸ“¦</span>
                <h3 class="h5 fw-bold mb-0">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
            </div>
            <div class="product-grid">
                {% for product in other_products %}
                    {% include "product_card_snippet.html" %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Empty State -->
        {% if not offer_products and not new_products and not other_products %}
        <div class="text-center py-5">
            <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fas fa-search fa-2x text-muted"></i>
            </div>
            <h4 class="fw-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</h4>
            <p class="text-muted">Ù„Ù… Ù†Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯.</p>
            <a href="{% url 'store_home' supplier.store_id %}" class="btn btn-outline-dark rounded-pill mt-3">ØªØ­Ø¯ÙŠØ«</a>
        </div>
        {% endif %}
        
    </div>

</div> <!-- /.product-page-wrapper -->

<!-- 4. PENDING ORDERS (Float/Sheet) -->
{% if pending_orders %}
<!-- Floating Trigger (Pill) -->
<div class="pending-orders-floating dismissible" onclick="togglePendingOrdersSidebar()" 
     style="position: fixed; bottom: 100px; right: 20px; z-index: 900; background: white; padding: 8px 16px; border-radius: 30px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid var(--surface-3);">
    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 20px; height: 20px; font-size: 10px; font-weight: bold;">
        {{ pending_orders|length }}
    </div>
    <span class="fs-7 fw-bold text-dark">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</span>
</div>

<!-- Slide-over Sheet -->
<div class="sheet-overlay" id="sidebarOverlay" onclick="closePendingOrdersSidebar()"></div>
<div class="order-sheet" id="pendingOrdersSidebar">
    <div class="p-4 border-bottom d-flex justify-content-between align-items-center bg-white sticky-top">
        <h5 class="fw-bold mb-0">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h5>
        <button class="btn btn-icon btn-sm btn-light rounded-circle" onclick="closePendingOrdersSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="flex-grow-1 overflow-auto p-3" id="ordersContainer">
        <!-- Loop logic kept from original, simplified structure -->
        {% for order in pending_orders %}
        <div class="card border-0 shadow-sm mb-3 rounded-4 overflow-hidden" data-order-id="{{ order.id }}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-warning bg-opacity-10 text-warning px-3 rounded-pill">{{ order.pipeline_status.name }}</span>
                    <small class="text-muted fw-bold">#{{ order.id }}</small>
                </div>
                
                <h4 class="fw-bold mb-1">{{ order.get_total_after_discount|floatformat:0 }} {{ supplier.currency }}</h4>
                <p class="text-muted small mb-3">{{ order.order_items.count }} Ù…Ù†ØªØ¬Ø§Øª â€¢ {{ order.created_at|date:"d M" }}</p>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-dark flex-grow-1 rounded-pill" onclick="showPaymentOptions({{ order.id }})">
                        Ø¯ÙØ¹
                    </button>
                    <button class="btn btn-sm btn-light flex-grow-1 rounded-pill" onclick="trackOrder({{ order.id }})">
                        ØªØªØ¨Ø¹
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}


<!-- 5. MOBILE CART ISLAND -->
{% if cart and cart.get_total_items > 0 %}
<div class="cart-island-wrapper d-lg-none">
    <div class="cart-island" id="mobileCartBar">
        <div class="cart-island-info">
            <span class="cart-island-count">{{ cart.get_total_items }} Ù…Ù†ØªØ¬Ø§Øª</span>
            <span class="cart-island-total">
                {% if supplier.enable_delivery_fees %}
                    {{ cart.get_total_after_discount|add:estimated_fee|floatformat:0 }}
                {% else %}
                    {{ cart.get_total_after_discount|floatformat:0 }}
                {% endif %}
                {{ supplier.currency }}
            </span>
        </div>
        <a href="{% url 'store_cart' supplier.store_id %}" class="cart-island-btn">
            Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</div>
{% endif %}

{% endblock %}


{% block extra_js %}
<script>
    // --- UI INTERACTIONS ---

    // 1. Category Nav Interactions (Pill Toggling)
    document.addEventListener('DOMContentLoaded', () => {
        const triggers = document.querySelectorAll('[data-cat-toggle]');
        triggers.forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                // Determine if we need to prevent default (if href="#" logic)
                // Here we want smooth interactions
                e.preventDefault();
                
                // Remove active classes
                document.querySelectorAll('[data-cat-toggle]').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.subcategory-bar').forEach(el => el.classList.remove('show'));
                
                // Add active
                trigger.classList.add('active');
                const targetId = trigger.getAttribute('href').replace('#', '');
                
                // Show specific sub bar
                const subBar = document.getElementById(targetId + '-subs');
                if(subBar) {
                    subBar.classList.add('show');
                }
                
                // Option: scroll to section? Or stick to filtering? 
                // Previous logic implies filtering. For now, visual toggle.
            });
        });
        
        // Wishlist Init
         {% if user.is_authenticated %}
         loadWishlistStatus();
         {% endif %}
         
         // Cart Status
         {% if user.is_authenticated %}
         loadCartStatus();
         {% endif %}
    });

    // 2. Pending Orders Sheet Controls
    function togglePendingOrdersSidebar() {
        // Toggle logic
        const el = document.getElementById('pendingOrdersSidebar');
        if(el.classList.contains('active')) closePendingOrdersSidebar();
        else openPendingOrdersSidebar();
    }

    function openPendingOrdersSidebar() {
        document.getElementById('pendingOrdersSidebar').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closePendingOrdersSidebar() {
        document.getElementById('pendingOrdersSidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // --- LOGIC PRESERVATION (Keep existing functions) ---

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load Wishlist Status
    function loadWishlistStatus() {
        // Collect all IDs to maybe batch request in future?
        // For now, keep per-item logic but use intersection observer to lazy load?
        // Or just run it.
        const btns = document.querySelectorAll('.wishlist-btn-float');
        btns.forEach(btn => {
            // Logic to check status if not server, rendered
        });
        
        // NOTE: If server-side rendering is good, we might not need this.
        // But assuming we need to fetch user state:
        const productIds = Array.from(document.querySelectorAll('[data-product-id]')).map(el => el.getAttribute('data-product-id'));
        if(productIds.length > 0) {
           // We could batch fetch here if endpoint supports it. 
           // Keeping original per-item fetch for safety but it's N+1 in frontend.
           // Leaving as placeholder for safety. 
           // Use previous logic:
           productIds.forEach(id => {
               fetch(`/wishlist/status/${id}/`, {headers:{'X-Requested-With': 'XMLHttpRequest'}})
               .then(res => res.ok ? res.json() : null)
               .then(data => {
                   if(data && data.success && data.in_wishlist) {
                       const b = document.querySelector(`[data-product-id="${id}"] .wishlist-btn-float`);
                       if(b) {
                           b.classList.add('active');
                           b.querySelector('i').className = 'fas fa-heart';
                       }
                   }
               });
           });
        }
    }
    
    // Cart Status (Keep existing)
    function loadCartStatus() {
        const supplierId = "{{ supplier.store_id }}";
        fetch(`/cart/status/${supplierId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.items) {
                     // Logic to update UI buttons if we had +/- controls on cards
                     // Current design just has "Add", so maybe we change "Add" to "Added"?
                }
                if (data.cart_items_count !== undefined) {
                    const els = document.querySelectorAll('#mobile-cart-count');
                    els.forEach(el => el.textContent = data.cart_items_count);
                }
            });
    }
    
    // Keep Order interactions
    function showPaymentOptions(id) { alert('Opening payment for ' + id); }
    function trackOrder(id) { alert('Tracking ' + id); }

</script>
{% endblock %}