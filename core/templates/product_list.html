{% extends 'base.html' %}
{% load static %}
{% load cart_filters %}

{% block title %}{{ supplier.name }} | المنتجات{% endblock %}

{% block extra_meta %}
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{{ supplier.name }} - تسوق أفضل المنتجات">
    <meta property="og:description" content="{% if supplier.description %}{{ supplier.description }}{% else %}استكشف تشكيلة واسعة من المنتجات المميزة لدى {{ supplier.name }}. تسوق الآن بأفضل الأسعار!{% endif %}">
    {% if supplier.panal_picture %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ supplier.panal_picture.url }}">
    {% elif supplier.profile_picture %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ supplier.profile_picture.url }}">
    {% else %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}">
    {% endif %}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta property="twitter:title" content="{{ supplier.name }}">
    <meta property="twitter:description" content="{% if supplier.description %}{{ supplier.description }}{% else %}استكشف تشكيلة واسعة من المنتجات المميزة لدى {{ supplier.name }}.{% endif %}">
    {% if supplier.panal_picture %}
    <meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ supplier.panal_picture.url }}">
    {% elif supplier.profile_picture %}
    <meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ supplier.profile_picture.url }}">
    {% endif %}
{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}?v={{ css_version }}">
<style>
    /* Dynamic Theme Variables */
    :root {
        --primary-color: {{ supplier.primary_color|default:'#F58231' }};
        --secondary-color: {{ supplier.secondary_color|default:'#ffffff' }};
        --accent-color: {{ supplier.accent_color|default:'#00FFFF' }};
        --navbar-bg: {{ supplier.navbar_color|default:'#F58231' }};
        --footer-bg: {{ supplier.footer_color|default:'#2B6CB0' }};
        --text-color: {{ supplier.text_color|default:'#4A5568' }};
        
        --glass-bg: rgba(255, 255, 255, 0.95);
        
        /* Removed all gradients in favor of solid colors */
        --primary-gradient: var(--primary-color);
        --secondary-gradient: var(--secondary-color);
        --success-gradient: var(--success-color);
        --warning-gradient: var(--warning-color);
        
        /* Dynamic Background */
        --body-bg-gradient: linear-gradient(135deg, {{ supplier.primary_color|default:'#F58231' }}1A 0%, {{ supplier.secondary_color|default:'#ffffff' }}1A 100%);
    }
    
    @media (max-width: 768px) {
        .modern-ads-title {
            font-size: 0.95rem !important;
            margin-bottom: 0.1rem !important;
        }
        .modern-ads-description {
            font-size: 0.65rem !important;
            margin-bottom: 0.25rem !important;
            line-height: 1.1 !important;
            -webkit-line-clamp: 2;
        }
        .modern-ads-cta {
            padding: 2px 10px !important;
            font-size: 0.65rem !important;
            border-radius: 15px !important;
        }
        /* Reduce gap in hero */
        .modern-hero {
            padding: 1.5rem 0 !important;
        }
        .hero-title {
            font-size: 1.25rem !important;
        }
        .hero-subtitle {
            font-size: 0.8rem !important;
            margin-bottom: 0 !important;
        }

        /* Force Category Button Active State to be less orange */
        .modern-category-btn.active {
            background: var(--brand-slate, #2B6CB0) !important;
            color: white !important;
            border-color: var(--primary-color, #F58231) !important;
            box-shadow: 0 8px 20px rgba(43, 108, 176, 0.25) !important;
        }

        /* Force Category Button Active State to be less orange */
        .modern-category-btn.active {
            background: var(--brand-slate, #2B6CB0) !important;
            color: white !important;
            border-color: var(--primary-color, #F58231) !important;
            box-shadow: 0 8px 20px rgba(43, 108, 176, 0.25) !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
{% if supplier_ads %}
<<!-- Premium Ads Carousel Section -->
<div class="container-fluid px-0 mb-4" style="margin-top: -30px;">
    <section class="modern-ads-carousel">
        <!-- Main Carousel Container with Curves -->
        <div id="supplierAdsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="6000" style="border-radius: 0 0 40px 40px; overflow: hidden; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);">
        
        <!-- Modern Dot Indicators -->
        <div class="carousel-indicators" style="bottom: 15px; margin-bottom: 0;">
            {% for ad in supplier_ads %}
            <button type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                    {% if forloop.first %}class="active" aria-current="true"{% endif %} 
                    aria-label="Slide {{ forloop.counter }}"
                    style="width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); border: none; margin: 0 4px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
                    onmouseover="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='scale(1.2)';"
                    onmouseout="if(!this.classList.contains('active')) { this.style.background='rgba(255,255,255,0.5)'; this.style.transform='scale(1)'; }"></button>
            {% endfor %}
        </div>
        
        <style>
            .carousel-indicators .active {
                background: rgba(255,255,255,1) !important;
                transform: scale(1.3) !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
        </style>
        
        <!-- Carousel items -->
        <div class="carousel-inner">
            {% for ad in supplier_ads %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="6000">
                <!-- Gradient Overlay for Readability -->
                <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.3) 100%); z-index: 1;"></div>
                
                <!-- Glassmorphic Content Badge -->
                <div style="position: absolute; inset: 0; z-index: 2; display: flex; align-items: center; justify-content: flex-end; padding: 0 80px 0 5%;">
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 24px; padding: 1.5rem 2rem; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-width: 380px; animation: slideInRight 0.6s ease-out;">
                        {% if ad.title %}
                        <h1 style="color: #fff; font-size: 1.75rem; font-weight: 700; margin-bottom: 0.75rem; text-shadow: 0 2px 10px rgba(0,0,0,0.3); line-height: 1.2;">{{ ad.title }}</h1>
                        {% endif %}
                        
                        {% if ad.description %}
                        <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; margin-bottom: 1.25rem; line-height: 1.5; text-shadow: 0 1px 3px rgba(0,0,0,0.2);">{{ ad.description }}</p>
                        {% endif %}
                        
                        <!-- Premium CTA Button -->
                        {% if ad.product %}
                        <a href="{% url 'product_detail' store_id=supplier.store_id pk=ad.product.id %}" 
                           style="display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, var(--brand-slate, #2B6CB0) 0%, var(--accent-color, #00FFFF) 100%); color: #fff; padding: 0.75rem 1.75rem; border-radius: 50px; font-weight: 600; font-size: 0.95rem; text-decoration: none; box-shadow: 0 4px 15px rgba(43, 108, 176, 0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid rgba(255,255,255,0.2);"
                           onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(43, 108, 176, 0.4)';"
                           onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(43, 108, 176, 0.3)';">
                            <span>استكشف العرض</span>
                            <i class="fas fa-arrow-left" style="transition: transform 0.3s;"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Image -->
                <img src="{{ ad.image.url }}" class="d-block w-100" alt="{{ ad.title }}" loading="lazy" style="object-fit: fill; height: 300px; width: 100%;">
            </div>
            {% endfor %}
        </div>
        
        <!-- Sleek Modern Controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide="prev" style="width: 50px; opacity: 1; z-index: 10;">
            <div style="width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s;"
                 onmouseover="this.style.background='rgba(255,255,255,0.4)'; this.style.transform='scale(1.1)';"
                 onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1)';">
                <i class="fas fa-chevron-right" style="color: #fff; font-size: 1rem;"></i>
            </div>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide="next" style="width: 50px; opacity: 1; z-index: 10;">
            <div style="width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s;"
                 onmouseover="this.style.background='rgba(255,255,255,0.4)'; this.style.transform='scale(1.1)';"
                 onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1)';">
                <i class="fas fa-chevron-left" style="color: #fff; font-size: 1rem;"></i>
            </div>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
    
    <style>
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            #supplierAdsCarousel {
                border-radius: 0 0 30px 30px !important;
            }
            
            #supplierAdsCarousel .carousel-item img {
                height: 200px !important;
            }
            
            #supplierAdsCarousel h1 {
                font-size: 1.1rem !important;
            }
            
            #supplierAdsCarousel p {
                font-size: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            
            #supplierAdsCarousel a {
                padding: 0.5rem 1.25rem !important;
                font-size: 0.8rem !important;
            }
            
            #supplierAdsCarousel > div > div {
                padding: 1rem 1.5rem !important;
                max-width: 90% !important;
            }
        }
    </style>
</section>
{% else %}
<!-- Modern Hero Section (if no ads available) -->
<section class="modern-hero">
    <div class="container hero-content">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="hero-title">منتجات {{ supplier.name }}</h1>
                <p class="hero-subtitle">استكشف جميع المنتجات المتاحة من هذا المتجر</p>
            </div>
            
        </div>
    </div>
</section>
{% endif %}

<!-- Floating Pending Orders Notification -->
    {% if pending_orders %}
<div class="pending-orders-floating dismissible" onclick="togglePendingOrdersSidebar()">
    <button class="dismiss-btn" onclick="dismissNotification(event)" title="إخفاء الإشعار">
        <i class="fas fa-times"></i>
    </button>
        <div class="d-flex align-items-center">
        <div class="pending-count-badge me-2" style="width:24px; height:24px; font-size:10px;">{{ pending_orders|length }}</div>
        <div>
            <div class="fw-bold" style="font-size: 0.8rem;">طلبات معلقة</div>
            <div class="small opacity-75" style="font-size: 0.65rem;">اضغط للتفاصيل</div>
                </div>
        <i class="fas fa-bell ms-2" style="font-size: 0.9rem;"></i>
    </div>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closePendingOrdersSidebar()"></div>

<!-- Pending Orders Sidebar -->
<div class="pending-orders-sidebar" id="pendingOrdersSidebar">
    <div class="sidebar-header">
        <div class="d-flex w-100">
            <div class="sidebar-title-area">
                <h3 class="mb-1">الطلبات المعلقة</h3>
                <p class="opacity-75 mb-0 small">{{ pending_orders|length }} طلب بانتظار الدفع</p>
            </div>
            <button class="sidebar-close" onclick="closePendingOrdersSidebar()" title="إغلاق">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
            
    <!-- Modern Stats Dashboard -->
    <div class="order-stats-panel">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <span class="stat-label">الكمية</span>
            <span class="stat-value">{{ pending_orders|length }}</span>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-wallet"></i>
            </div>
            <span class="stat-label">الإجمالي</span>
            <span class="stat-value">
                {% widthratio pending_orders|length 1 1000 as total_amount %}
                {{ total_amount|default:"0" }}
            </span>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-chart-line"></i>
            </div>
            <span class="stat-label">المتوسط</span>
            <span class="stat-value">
                {% if pending_orders %}
                    {% widthratio total_amount pending_orders|length 1 as avg_amount %}
                    {{ avg_amount|default:"0" }}
                {% else %}
                    0
                {% endif %}
            </span>
        </div>
    </div>
    <div class="sidebar-body" id="ordersContainer">
                {% for order in pending_orders %}
        <div class="pending-order-card animate-fade-in-up" data-order-id="{{ order.id }}" style="animation-delay: {{ forloop.counter0|multiply:0.1 }}s">
            <div class="order-meta">
                <span class="status-badge pending">
                    <i class="fas fa-clock me-1"></i> {{ order.pipeline_status.name }}
                </span>
                <div class="dropdown">
                    <button class="order-actions-trigger" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-4">
                        <li><button class="dropdown-item py-2" onclick="duplicateOrder({{ order.id }})"><i class="fas fa-copy me-2 text-muted"></i> تكرار</button></li>
                        <li><button class="dropdown-item py-2" onclick="editOrder({{ order.id }})"><i class="fas fa-edit me-2 text-muted"></i> تعديل</button></li>
                        <li><button class="dropdown-item py-2 text-danger" onclick="cancelOrder({{ order.id }})"><i class="fas fa-trash-alt me-2"></i> إلغاء</button></li>
                    </ul>
                </div>
            </div>
            
            <div class="order-main-info">
                <span class="order-id-label">رقم الطلب</span>
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="order-id-value mb-0">#{{ order.id }}</h4>
                    <div class="order-price-box">
                        {% if order.has_discount or supplier.enable_delivery_fees %}
                            <span class="order-original-price small">{{ order.total_amount|floatformat:0 }}</span>
                            <span class="order-total-price">{{ order.get_total_after_discount|floatformat:0 }} <small class="fw-normal" style="font-size: 0.6em;">{{ supplier.currency }}</small></span>
                        {% else %}
                            <span class="order-total-price">{{ order.total_amount|floatformat:0 }} <small class="fw-normal" style="font-size: 0.6em;">{{ supplier.currency }}</small></span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="order-details-mini">
                <div class="mini-detail">
                    <i class="far fa-calendar-alt"></i>
                    {{ order.created_at|date:"d M, H:i" }}
                </div>
                <div class="mini-detail">
                    <i class="fas fa-layer-group"></i>
                    {{ order.order_items.count }} صنف
                </div>
            </div>
            
            <div class="payment-strip">
                {% with first_item=order.order_items.first %}
                {% if first_item %}
                <a href="https://wa.me/{{ first_item.product.supplier.phone }}?text=أريد دفع ثمن الطلب رقم {{ order.id }} بقيمة {{ order.get_total_after_discount|floatformat:0 }} {{ supplier.currency }}" 
                   class="btn-payment-action whatsapp" target="_blank">
                    <i class="fab fa-whatsapp"></i>  تواصل بـ {{ first_item.product.supplier.name }}
                </a>
                {% endif %}
                {% endwith %}
                <button class="btn-payment-action details" data-bs-toggle="modal" data-bs-target="#orderDetailsModal{{ order.id }}">
                    مشاهدة
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Order Details Modals (Outside Sidebar) -->
{% for order in pending_orders %}
<div class="modal fade modern-modal" id="orderDetailsModal{{ order.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                <h5 class="modal-title">تفاصيل الطلب #{{ order.id }}</h5>
            </div>
            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-card">
                        <i class="fas fa-calendar-alt text-primary"></i>
                        <span class="modal-info-label">التاريخ</span>
                        <span class="modal-info-value">{{ order.created_at|date:"d M, H:i" }}</span>
                    </div>
                    <div class="modal-info-card">
                        <i class="fas fa-info-circle text-warning"></i>
                        <span class="modal-info-label">الحالة</span>
                        <span class="modal-info-value">{{ order.pipeline_status.name }}</span>
                    </div>
                    <div class="modal-info-card">
                        <i class="fas fa-box text-info"></i>
                        <span class="modal-info-label">المنتجات</span>
                        <span class="modal-info-value">{{ order.order_items.count }} أصناف</span>
                    </div>
                </div>
                
                <h6 class="fw-bold mb-3 d-flex align-items-center">
                    <i class="fas fa-list-ul me-2 text-primary"></i> قائمة المنتجات
                </h6>
                
                <div class="modal-items-container">
                    {% for item in order.order_items.all %}
                    <div class="modern-order-item-strip">
                        <img src="{{ item.product.image.url }}" class="item-strip-img" alt="{{ item.product.name }}">
                        <div class="item-strip-info">
                            <h6 class="item-strip-name">{{ item.product.name }}</h6>
                            <p class="item-strip-desc">{{ item.product.description|truncatewords:8 }}</p>
                        </div>
                        <div class="item-strip-pricing">
                            <span class="item-strip-qty">الكمية: {{ item.quantity }}</span>
                            {% if item.has_discount %}
                                <div class="small text-muted text-decoration-line-through">{{ item.product.price|floatformat:0 }}</div>
                                <div class="item-strip-price">{{ item.product.get_price_with_offer|floatformat:0 }} <small>{{ supplier.currency }}</small></div>
                            {% else %}
                                <div class="item-strip-price">{{ item.product.price|floatformat:0 }} <small>{{ supplier.currency }}</small></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="modal-finance-summary">
                    <div class="finance-row">
                        <span class="label text-muted">المجموع الفرعي:</span>
                        <span class="value fw-bold">{{ order.total_amount|floatformat:0 }} {{ supplier.currency }}</span>
                    </div>
                    {% if supplier.enable_delivery_fees %}
                    <div class="finance-row">
                        <span class="label text-muted">رسوم التوصيل:</span>
                        <span class="value text-success">+{{ order.get_expected_delivery_fee|floatformat:0 }} {{ supplier.currency }}</span>
                    </div>
                    {% endif %}
                    <div class="finance-row total">
                        <span class="label">الإجمالي الكلي:</span>
                        <span class="value">{{ order.get_total_after_discount|floatformat:0 }} {{ supplier.currency }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <a href="https://wa.me/+967779923330?text=أريد دفع ثمن الطلب رقم {{ order.id }} بقيمة {{ order.get_total_after_discount|floatformat:0 }} {{ supplier.currency }}" 
                   class="modern-whatsapp-btn" target="_blank">
                    <i class="fab fa-whatsapp"></i> الدفع عبر واتساب
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

    <!-- Categories Navigation -->
<div class="container mt-2 mb-2">
    <div class="modern-category-nav py-1 px-2">
        <div class="modern-category-title" style="font-size: 0.85rem;">
            <i class="fas fa-filter me-1 text-primary"></i> التصنيفات
        </div>
        
        <div class="d-flex flex-nowrap overflow-auto py-1 gap-2 modern-scroll categories-scroll-container flex-grow-1">
            <a href="{% url 'product-list' supplier.store_id %}" class="modern-category-btn {% if not active_category_id %}active{% endif %} flex-shrink-0">
                الكل
            </a>
            
            {% for category in categories %}
            <a href="#subcategory-{{ category.id }}" 
               class="modern-category-btn flex-shrink-0" 
               data-bs-toggle="collapse" 
               aria-expanded="false">
                {{ category.name }} <i class="fas fa-chevron-down ms-1" style="font-size: 0.8em; opacity: 0.7;"></i>
            </a>
            {% endfor %}
        </div>
    </div>
        
        <!-- Subcategories Section -->
        {% for category in categories %}
        <div id="subcategory-{{ category.id }}" class="collapse modern-subcategory-panel">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="small fw-bold text-muted me-2"><i class="fas fa-level-down-alt fa-rotate-180 ms-1"></i> {{ category.name }}:</span>
                
                {% for subcategory in category.productcategory_set.all %}
                <a href="{% url 'product_list_subcategory' subcategory.id supplier.store_id %}" 
                   class="modern-subcategory-btn">
                    {{ subcategory.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="container container-products mt-3">
    
    {% if offer_products %}
    <div class="product-section offers-premium-section mb-4">
        <div class="d-flex align-items-center mb-3 px-2">
            <div class="section-icon-wrapper bg-red-100 text-red-500 rounded-circle shadow-sm fire-pulse" style="width: 32px; height: 32px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-fire"></i>
            </div>
            <h6 class="section-title m-0 ms-2 fw-bold">أقوى العروض</h6>
            <span class="badge premium-badge-count rounded-pill ms-auto">{{ offer_products|length }} عرض</span>
        </div>
        <div class="premium-scroll-wrapper">
            <div class="products-horizontal-scroll pb-1">
                {% for product in offer_products %}
                    {% include "product_card_snippet.html" %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if new_products %}
    <div class="product-section mb-3">
        <div class="d-flex align-items-center mb-2 px-1">
            <div class="section-icon-wrapper bg-blue-100 text-blue-500 rounded-circle p-1 me-2" style="width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-certificate fa-sm"></i>
            </div>
            <h6 class="section-title m-0 fw-bold" style="font-size: 0.95rem;">وصل حديثاً</h6>
            <span class="badge bg-primary rounded-pill ms-auto" style="font-size: 0.65rem;">{{ new_products|length }}</span>
        </div>
        <div class="products-horizontal-scroll pb-1">
            {% for product in new_products %}
                {% include "product_card_snippet.html" %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if other_products %}
    <div class="product-section mb-3">
        <div class="d-flex align-items-center mb-2 px-1">
            <div class="section-icon-wrapper bg-gray-100 text-gray-500 rounded-circle p-1 me-2" style="width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-th fa-sm"></i>
            </div>
            <h6 class="section-title m-0 fw-bold" style="font-size: 0.95rem;">جميع المنتجات</h6>
        </div>
        <div class="products-horizontal-scroll pb-1">
            {% for product in other_products %}
                {% include "product_card_snippet.html" %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if not offer_products and not new_products and not other_products %}
        <div class="text-center py-5">
            <div class="empty-state-icon mb-3">
                <i class="fas fa-box-open fa-3x text-muted opacity-50"></i>
            </div>
            <h3 class="text-muted">لا توجد منتجات متاحة حالياً</h3>
        </div>
    {% endif %}
</div>
</div>

<!-- Floating Cart Button for Mobile -->
<!-- Mobile Bottom Cart Bar -->
<div class="mobile-cart-bar d-lg-none {% if cart.get_total_items == 0 %}d-none{% endif %}" id="mobileCartBar">
    <div class="cart-info">
        <div class="cart-count">
            <i class="fas fa-shopping-basket"></i>
            <span id="mobile-cart-count">{{ cart.get_total_items }}</span> منتجات
        </div>
        <div class="cart-total">
            <span class="text-muted small">المجموع:</span>
            <span class="total-price" id="mobile-cart-total">
                {% if supplier.enable_delivery_fees %}
                    {{ cart.get_total_after_discount|add:estimated_fee|floatformat:0 }}
                {% else %}
                    {{ cart.get_total_after_discount|floatformat:0 }}
                {% endif %}
            </span> {{ supplier.currency }}
        </div>
    </div>
    <a href="{% url 'cart-detail' supplier.store_id %}" class="cart-action-btn">
        مشاهدة السلة <i class="fas fa-arrow-left me-2"></i>
    </a>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    try {
        if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        } else {
            // If bootstrap not yet available, initialize on DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof bootstrap === 'undefined') return;
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            });
        }
    } catch (err) {
        console.warn('Tooltip initialization skipped:', err);
    }
    
    // Wishlist functionality with AJAX
    function toggleWishlist(productId) {
        const wishlistBtn = document.querySelector(`[data-product-id="${productId}"] .wishlist-btn`);
        const icon = wishlistBtn.querySelector('i');
        
        // Disable button during request
        wishlistBtn.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                         getCookie('csrftoken');
        
        // Make AJAX request
        fetch(`/wishlist/toggle/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.in_wishlist) {
                    wishlistBtn.classList.add('active');
                    icon.className = 'fas fa-heart';
                    showToast(data.message || 'تم إضافة المنتج للمفضلة', 'success');
                } else {
                    wishlistBtn.classList.remove('active');
                    icon.className = 'far fa-heart';
                    showToast(data.message || 'تم إزالة المنتج من المفضلة', 'info');
                }
            } else {
                showToast(data.message || 'حدث خطأ أثناء تحديث المفضلة', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('حدث خطأ في الاتصال', 'error');
        })
        .finally(() => {
            // Re-enable button
            wishlistBtn.disabled = false;
        });
    }
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Load initial wishlist status for all products
    function loadWishlistStatus() {
        const productCards = document.querySelectorAll('.modern-product-card');

        productCards.forEach(card => {
            const productId = card.getAttribute('data-product-id');
            const wishlistBtn = card.querySelector('.wishlist-btn');
            if (!productId || !wishlistBtn) return; // guard

            // ensure icon exists
            let icon = wishlistBtn.querySelector('i');
            if (!icon) {
                icon = document.createElement('i');
                icon.className = 'far fa-heart';
                wishlistBtn.appendChild(icon);
            }

            fetch(`/wishlist/status/${productId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.status === 401) {
                    // not authenticated (or backend returned 401) — stop here
                    return { success: false, login_required: true };
                }
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    // unexpected response (HTML redirect to login) — don't throw
                    return { success: false };
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success && data.in_wishlist) {
                    wishlistBtn.classList.add('active');
                    icon.className = 'fas fa-heart';
                } else {
                    wishlistBtn.classList.remove('active');
                    icon.className = 'far fa-heart';
                }
            })
            .catch(error => {
                console.error('Error loading wishlist status:', error);
            });
        });
    }
    
    // Quick view functionality
    function quickView(productId) {
        // Create and show quick view modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">عرض سريع للمنتج</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
        
        // Here you can add AJAX call to load product details
        setTimeout(() => {
            modal.querySelector('.modal-body').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <img src="/static/placeholder-product.jpg" class="img-fluid rounded" alt="Product">
                    </div>
                    <div class="col-md-6">
                        <h4>اسم المنتج</h4>
                        <p class="text-muted">وصف المنتج هنا...</p>
                        <h5 class="text-primary">299 {{ supplier.currency }}</h5>
                        <button class="btn btn-primary">إضافة للسلة</button>
                    </div>
                </div>
            `;
        }, 1000);
    }
    
    // Social sharing functions
    function shareWhatsApp(productName, productId) {
        const url = window.location.origin + '/{{ supplier.store_id }}/details/' + productId + '/';
        const text = encodeURIComponent(`شاهد هذا المنتج الرائع: ${productName}`);
        window.open(`https://wa.me/?text=${text} ${url}`, '_blank');
    }
    
    function shareFacebook(productId) {
        const url = window.location.origin + '/{{ supplier.store_id }}/details/' + productId + '/';
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }
    

    
    function copyProductLink(productId) {
        const url = window.location.origin + '/{{ supplier.store_id }}/details/' + productId + '/';
        navigator.clipboard.writeText(url).then(() => {
            showToast('تم نسخ رابط المنتج', 'success');
        }).catch(() => {
            showToast('فشل في نسخ الرابط', 'error');
        });
    }
    
    function shareProduct(productId) {
        const menu = document.getElementById(`share-menu-${productId}`);
        if (menu) {
            menu.classList.toggle('active');
            
            // Auto-hide after 5 seconds
            if (menu.classList.contains('active')) {
                setTimeout(() => {
                    menu.classList.remove('active');
                }, 5000);
            }
        }
    }
    
    function compareProduct(productId) {
        showToast('تم إضافة المنتج للمقارنة', 'info');
        // Here you can add compare functionality
    }
    
    // Show login prompt for non-authenticated users
    function showLoginPrompt() {
        if (typeof openLoginModal === 'function') {
            openLoginModal();
        } else {
            window.location.href = "{% url 'login' %}";
        }
    }
    
    // Pending Orders Sidebar Functions
    function togglePendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar.classList.contains('active')) {
            closePendingOrdersSidebar();
        } else {
            openPendingOrdersSidebar();
        }
    }
    
    function openPendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        sidebar.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closePendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Close sidebar on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePendingOrdersSidebar();
            closeAllOrderMenus();
        }
    });
    
    // Dismiss notification functionality
    function dismissNotification(event) {
        event.stopPropagation();
        const notification = document.querySelector('.pending-orders-floating');
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.style.display = 'none', 300);
        localStorage.setItem('pendingOrdersDismissed', Date.now());
    }
    
    // Order menu functionality
    function toggleOrderMenu(orderId) {
        const menu = document.getElementById(`orderMenu${orderId}`);
        const isActive = menu.classList.contains('active');
        closeAllOrderMenus();
        if (!isActive) menu.classList.add('active');
    }
    
    function closeAllOrderMenus() {
        document.querySelectorAll('.order-menu-dropdown').forEach(menu => {
            menu.classList.remove('active');
        });
    }
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.order-menu')) closeAllOrderMenus();
    });
    
    // Order actions
    function duplicateOrder(orderId) {
        showToast(`جاري تكرار الطلب #${orderId}...`, 'info');
        setTimeout(() => showToast(`تم تكرار الطلب #${orderId} بنجاح`, 'success'), 1500);
        closeAllOrderMenus();
    }
    
    function editOrder(orderId) {
        showToast(`جاري فتح محرر الطلب #${orderId}...`, 'info');
        closeAllOrderMenus();
    }
    
    function trackOrder(orderId) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تتبع الطلب #${orderId}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                            <h6>تم إنشاء الطلب</h6>
                            <small class="text-muted">اليوم 10:30 ص</small>
                        </div>
                        <div class="mb-3">
                            <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                            <h6>في انتظار الدفع</h6>
                            <small class="text-muted">حالي</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => document.body.removeChild(modal));
        closeAllOrderMenus();
    }
    
    function cancelOrder(orderId) {
        if (confirm(`هل أنت متأكد من إلغاء الطلب #${orderId}؟`)) {
            showToast(`جاري إلغاء الطلب #${orderId}...`, 'info');
            setTimeout(() => {
                showToast(`تم إلغاء الطلب #${orderId} بنجاح`, 'success');
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    orderCard.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => orderCard.remove(), 500);
                }
            }, 1500);
        }
        closeAllOrderMenus();
    }
    
    function showPaymentOptions(orderId) {
        showToast('جاري فتح خيارات الدفع...', 'info');
    }
    
    // Search and filter initialization
    function initializeOrderSearch() {
        const searchInput = document.getElementById('orderSearchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toUpperCase();
                filterOrders(filter);
            });
        }
    }
    
    function initializeFilterTabs() {
        const filterTabs = document.querySelectorAll('.filter-tab');
        filterTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                filterTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const statusFilter = this.getAttribute('data-filter');
                filterOrders('', statusFilter);
            });
        });
    }
    
    function filterOrders(searchFilter, statusFilter = 'all') {
        const orderCards = document.querySelectorAll('.pending-order-card');
        let visibleCount = 0;
        
        orderCards.forEach(card => {
            const orderId = card.querySelector('.order-id').textContent.toUpperCase();
            const orderStatus = card.getAttribute('data-order-status') || 'pending';
            
            let shouldShow = true;
            
            if (searchFilter && !orderId.includes(searchFilter)) {
                shouldShow = false;
            }
            
            if (statusFilter !== 'all' && statusFilter !== orderStatus) {
                shouldShow = false;
            }
            
            card.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) visibleCount++;
        });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
    
    function loadCartStatus() {
        const supplierId = "{{ supplier.store_id }}";
        fetch(`/cart/status/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.items) {
                    data.items.forEach(item => {
                        const productId = item.product_id;
                        const quantity = item.quantity;
                        
                        const qtyCtrl = document.getElementById(`qty-ctrl-${productId}`);
                        const addBtn = document.getElementById(`add-btn-${productId}`);
                        const qtyDisplay = document.getElementById(`total-qty-items-${productId}`);
                        
                        if (qtyCtrl && addBtn && qtyDisplay && quantity > 0) {
                            qtyCtrl.classList.remove('d-none');
                            addBtn.classList.add('d-none');
                            qtyDisplay.textContent = quantity;
                        }
                    });
                    
                    // Update global cart counts if necessary
                    if (data.cart_items_count !== undefined) {
                        const cartCount = document.getElementById('total-items');
                        const cartCountMobile = document.getElementById('total-items-mobile');
                        if (cartCount) cartCount.textContent = data.cart_items_count;
                        if (cartCountMobile) cartCountMobile.textContent = data.cart_items_count;
                    }
                }
            })
            .catch(error => console.error('Error fetching cart status:', error));
    }

    // Enhanced animations for product cards
    document.addEventListener('DOMContentLoaded', function() {
        const productCards = document.querySelectorAll('.modern-product-card');
        
        // Load wishlist status for authenticated users
        {% if user.is_authenticated %}
        loadWishlistStatus();
        loadCartStatus();
        {% endif %}
        
        // Initialize pending orders features
        {% if pending_orders %}
        initializeOrderSearch();
        initializeFilterTabs();
        initializeModalHandling();
        {% endif %}
        
        // Intersection Observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);
        
        productCards.forEach((card) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });
        
        // Handle category collapse behavior
        const categoryButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
        categoryButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Close other open category panels
                const target = this.getAttribute('href');
                categoryButtons.forEach(btn => {
                    if (btn !== this && btn.getAttribute('href') !== '#pendingOrdersCollapse') {
                        const otherTarget = btn.getAttribute('href');
                        if (otherTarget && otherTarget.startsWith('#subcategory-')) {
                            const collapse = bootstrap.Collapse.getInstance(document.querySelector(otherTarget));
                            if (collapse) {
                                collapse.hide();
                            }
                        }
                    }
                });
            });
        });
        
        // Parallax effect for hero section
        if (document.querySelector('.modern-hero')) {
            window.addEventListener('scroll', function() {
                const scrolled = window.pageYOffset;
                const hero = document.querySelector('.modern-hero');
                if (hero) {
                    hero.style.backgroundPositionY = -(scrolled * 0.2) + 'px';
                }
            });
        }
    });
</script>
{% endblock %}