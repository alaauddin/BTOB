{% extends 'base.html' %}
{% load static %}
{% load cart_filters %}

{% block title %}منتجات {{ supplier.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
<style>
    /* Dynamic Theme Variables */
    :root {
        --primary-color: {{ supplier.primary_color|default:'#2563eb' }};
        --secondary-color: {{ supplier.secondary_color|default:'#ffffff' }};
        --accent-color: {{ supplier.accent_color|default:'#2563eb' }};
        --navbar-bg: {{ supplier.navbar_color|default:'#2563eb' }};
        --footer-bg: {{ supplier.footer_color|default:'#1e293b' }};
        --text-color: {{ supplier.text_color|default:'#1e293b' }};
        
        --glass-bg: rgba(255, 255, 255, 0.95);
        
        /* Removed all gradients in favor of solid colors */
        --primary-gradient: var(--primary-color);
        --secondary-gradient: var(--secondary-color);
        --success-gradient: var(--success-color);
        --warning-gradient: var(--warning-color);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
{% if supplier_ads %}
<!-- Premium Ads Carousel Section -->
<div class="container mb-5" style="margin-top: 2rem;">
    <section class="modern-ads-carousel">
        <!-- Decorative Elements -->
        <div class="ads-decorative-element element-1"></div>
        <div class="ads-decorative-element element-2"></div>
        
        <div id="supplierAdsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="6000">
        <!-- Indicators -->
        <div class="carousel-indicators modern-carousel-indicators">
            {% for ad in supplier_ads %}
            <button type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                    {% if forloop.first %}class="active" aria-current="true"{% endif %} 
                    aria-label="Slide {{ forloop.counter }}"></button>
            {% endfor %}
        </div>
        
        <!-- Carousel items -->
        <div class="carousel-inner">
            {% for ad in supplier_ads %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="6000">
                <img src="{{ ad.image.url }}" class="d-block w-100" alt="{{ ad.title }}" loading="lazy">
                <div class="modern-ads-overlay">
                    <div class="container modern-ads-content">
                        {% if ad.title %}
                        <h1 class="modern-ads-title">{{ ad.title }}</h1>
                        {% endif %}
                        
                        {% if ad.description %}
                        <p class="modern-ads-description">{{ ad.description }}</p>
                        {% endif %}
                        
                        <!-- Enhanced Call-to-Action -->
                        <a href="{% url 'product_detail' ad.product.id %}" class="modern-ads-cta">
                            استكشف المنتجات
                            <i class="fas fa-arrow-left"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Premium Controls -->
        <button class="carousel-control-prev modern-carousel-control-prev" type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next modern-carousel-control-next" type="button" data-bs-target="#supplierAdsCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</section>
{% else %}
<!-- Modern Hero Section (if no ads available) -->
<section class="modern-hero">
    <div class="container hero-content">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="hero-title">منتجات {{ supplier.name }}</h1>
                <p class="hero-subtitle">استكشف جميع المنتجات المتاحة من هذا المتجر</p>
            </div>
            
        </div>
    </div>
</section>
{% endif %}

<!-- Floating Pending Orders Notification -->
    {% if pending_orders %}
<div class="pending-orders-floating dismissible" onclick="togglePendingOrdersSidebar()">
    <button class="dismiss-btn" onclick="dismissNotification(event)" title="إخفاء الإشعار">
        <i class="fas fa-times"></i>
    </button>
            <div class="d-flex align-items-center">
        <div class="pending-count-badge me-3">{{ pending_orders|length }}</div>
        <div>
            <div class="fw-bold">طلبات قيد الانتظار</div>
            <div class="small opacity-75">اضغط لعرض التفاصيل</div>
                </div>
        <i class="fas fa-bell ms-3"></i>
    </div>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closePendingOrdersSidebar()"></div>

<!-- Pending Orders Sidebar -->
<div class="pending-orders-sidebar" id="pendingOrdersSidebar">
    <div class="sidebar-header">
        <button class="sidebar-close" onclick="closePendingOrdersSidebar()">
            <i class="fas fa-times"></i>
                </button>
        <div class="sidebar-content">
            <h3 class="mb-2">الطلبات المعلقة</h3>
            <p class="opacity-75 mb-0">{{ pending_orders|length }} طلب بانتظار الدفع</p>
        </div>
            </div>
            
    <!-- Order Statistics -->
    <div class="order-stats-panel">
        <div class="stat-item">
            <span class="stat-label">إجمالي الطلبات</span>
            <span class="stat-value">{{ pending_orders|length }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">إجمالي المبلغ</span>
            <span class="stat-value">
                {% widthratio pending_orders|length 1 1000 as total_amount %}
                {{ total_amount|default:"0" }} {{ supplier.currency }}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">متوسط قيمة الطلب</span>
            <span class="stat-value">
                {% if pending_orders %}
                    {% widthratio total_amount pending_orders|length 1 as avg_amount %}
                    {{ avg_amount|default:"0" }} {{ supplier.currency }}
                {% else %}
                    0 {{ supplier.currency }}
                {% endif %}
            </span>
        </div>
    </div>
    <div class="sidebar-body" id="ordersContainer">
                {% for order in pending_orders %}
        <div class="pending-order-card" data-order-id="{{ order.id }}" data-order-status="{{ order.status|lower }}" data-order-date="{{ order.created_at|date:'Y-m-d' }}">
            <!-- Order Meta Information -->
            <div class="order-meta">
                <span class="order-status pending">{{ order.status }}</span>
                <div class="order-menu">
                    <button class="order-menu-btn" onclick="toggleOrderMenu({{ order.id }})">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="order-menu-dropdown" id="orderMenu{{ order.id }}">
                        <button class="menu-item" onclick="duplicateOrder({{ order.id }})">
                            <i class="fas fa-copy"></i> تكرار الطلب
                        </button>
                        <button class="menu-item" onclick="editOrder({{ order.id }})">
                            <i class="fas fa-edit"></i> تعديل الطلب
                        </button>
                        <button class="menu-item" onclick="trackOrder({{ order.id }})">
                            <i class="fas fa-truck"></i> تتبع الطلب
                        </button>
                        <button class="menu-item danger" onclick="cancelOrder({{ order.id }})">
                            <i class="fas fa-times"></i> إلغاء الطلب
                        </button>
                        </div>
                </div>
            </div>
            
            <div class="order-header">
                <div class="order-id">الطلب #{{ order.id }}</div>
                {% if order.has_discount %}
                <div class="text-muted text-decoration-line-through">{{ order.total_amount|floatformat:0 }} {{ supplier.currency }}</div>
                <div class="text-danger fw-bold">{{ order.get_total_ammout_with_discout|floatformat:0 }} {{ supplier.currency }}</div>

                {% else %}
                <div class="text-success fw-bold">{{ order.total_amount }} {{ supplier.currency }}</div>
                {% endif %}
                
            </div>
            
            <div class="text-muted small mb-3">
                <i class="fas fa-calendar me-2"></i>{{ order.created_at|date:"d/m/Y H:i" }}
                <span class="ms-3">
                    <i class="fas fa-box me-2"></i>{{ order.order_details.count }} منتج
                </span>
            </div>
            

            
            <!-- Enhanced Payment Methods -->
            <div class="payment-methods">
                <a href="https://wa.me/+967779923330?text=أريد دفع ثمن الطلب رقم {{ order.id }} بقيمة {{ order.total_amount }} {{ supplier.currency }}" 
                   class="payment-method whatsapp" target="_blank">
                    <i class="fab fa-whatsapp"></i>
                    واتساب
                </a>
                <button class="payment-method" data-bs-toggle="modal" data-bs-target="#orderDetailsModal{{ order.id }}">
                    <i class="fas fa-eye"></i>
                    التفاصيل
                </button>
                    </div>
                </div>
        {% endfor %}
    </div>
</div>

<!-- Order Details Modals (Outside Sidebar) -->
{% for order in pending_orders %}
<div class="modal fade modern-modal" id="orderDetailsModal{{ order.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل الطلب #{{ order.id }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-calendar text-primary me-2"></i>
                            <span class="fw-bold">تاريخ الطلب:</span>
                            <span class="ms-2">{{ order.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-info-circle text-warning me-2"></i>
                            <span class="fw-bold">الحالة:</span>
                            <span class="badge bg-warning text-dark ms-2">{{ order.status }}</span>
                        </div>
                    </div>
                </div>
                
                <h6 class="fw-bold mb-3">المنتجات:</h6>
                {% for item in order.order_items.all %}
                <div class="modern-order-item-card mb-3">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img src="{{ item.product.image.url }}" class="img-fluid rounded-start" alt="{{ item.product.name }}" style="height: 120px; object-fit: cover; width: 100%;">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">{{ item.product.name }}</h6>
                                <p class="card-text text-muted small mb-2">{{ item.product.description|truncatewords:10 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold">الكمية: {{ item.quantity }}</span>
                                    {% if item.has_discount %}
                                    <span class="text-muted text-decoration-line-through">{{ item.product.price|floatformat:0 }} {{ supplier.currency }}</span>
                                    <span class="text-danger fw-bold">{{ item.product.get_price_with_offer|floatformat:0 }} {{ supplier.currency }}</span>
                                    {% else %}
                                    <span class="text-success fw-bold">{{ item.product.price|floatformat:0 }} {{ supplier.currency }}</span>

                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <h5 class="mb-0">المجموع الكلي:</h5>
                    <h4 class="text-success mb-0">{{ order.total_amount }} {{ supplier.currency }}</h4>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://wa.me/+967779923330?text=أريد دفع ثمن الطلب رقم {{ order.id }} بقيمة {{ order.total_amount }} {{ supplier.currency }}" 
                   class="modern-whatsapp-btn" target="_blank">
                    <i class="fab fa-whatsapp"></i> الدفع عبر واتساب
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

    <!-- Categories Navigation -->
<div class="container">
    <div class="modern-category-nav">
        <h4 class="modern-category-title"><i class="fas fa-filter"></i> التصنيفات</h4>
        <div class="d-flex flex-wrap">
            <a href="{% url 'product-list' supplier.id %}" class="modern-category-btn {% if not active_category_id %}active{% endif %}">
                الكل
            </a>
            
            {% for category in categories %}
            <a href="#subcategory-{{ category.id }}" 
               class="modern-category-btn" 
               data-bs-toggle="collapse" 
               aria-expanded="false">
                {{ category.name }} <i class="fas fa-chevron-down me-2"></i>
            </a>
            
            {% endfor %}
        </div>
        
        <!-- Subcategories Section -->
        {% for category in categories %}
        <div id="subcategory-{{ category.id }}" class="collapse modern-subcategory-panel">
            <h5 class="mb-2">تصنيفات فرعية في {{ category.name }}</h5>
            <div class="d-flex flex-wrap">
                
                {% for subcategory in category.productcategory_set.all %}
                <a href="{% url 'product_list_subcategory' subcategory.id category.supplier.id %}" 
                   class="modern-subcategory-btn">
                    {{ subcategory.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

    <!-- Products Grid -->
<div class="container">
    <h2 class="section-title">المنتجات المتاحة</h2>
    
    {% if products %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="productsGrid">
        {% for product in products %}
        <div class="col animate-fade-in-up" style="animation-delay: {{ forloop.counter0|divisibleby:4|yesno:'0,0.1,0.2,0.3' }}s">
            <div class="modern-product-card" data-product-id="{{ product.id }}">
                <div class="modern-product-image-container">
                    <a href="{% url 'product_detail' pk=product.pk %}">
                        <img src="{{ product.image.url }}" class="modern-product-image" alt="{{ product.name }}">
                    </a>
                    
                    <!-- Glass Badges -->
                    {% if product.has_discount %}
                    <span class="modern-product-badge sale">خصم {{ product.get_discount_precentage }}%</span>
                    {% elif product.is_new %}
                    <span class="modern-product-badge">جديد</span>
                    {% endif %}
                    
                    <!-- Floating Wishlist -->
                    {% if user.is_authenticated %}
                    <button class="wishlist-btn" onclick="toggleWishlist({{ product.id }})" data-bs-toggle="tooltip" title="إضافة للمفضلة">
                        <i class="far fa-heart"></i>
                    </button>
                    {% else %}
                    <button class="wishlist-btn" onclick="showLoginPrompt()" data-bs-toggle="tooltip" title="سجل دخولك لإضافة المنتجات للمفضلة">
                        <i class="far fa-heart"></i>
                    </button>
                    {% endif %}
                    
                    <!-- Advanced Hover Overlay -->
                    <div class="product-overlay">
                        <div class="overlay-actions">
                            <a href="{% url 'product_detail' pk=product.pk %}" class="overlay-btn" data-bs-toggle="tooltip" title="عرض سريع">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="overlay-btn" onclick="shareProduct({{ product.id }})" data-bs-toggle="tooltip" title="مشاركة">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="modern-product-info">
                    <div class="product-category-tag">{{ product.category.name }}</div>
                    
                    <h3 class="modern-product-name">
                        <a href="{% url 'product_detail' pk=product.pk %}" class="text-decoration-none">{{ product.name }}</a>
                    </h3>
                    
                    <div class="product-rating">
                        <div class="stars">
                            {% with rating=product.get_average_rating %}
                                <i class="{% if rating >= 1 %}fas{% else %}far{% endif %} fa-star"></i>
                                <i class="{% if rating >= 2 %}fas{% else %}far{% endif %} fa-star"></i>
                                <i class="{% if rating >= 3 %}fas{% else %}far{% endif %} fa-star"></i>
                                <i class="{% if rating >= 4 %}fas{% else %}far{% endif %} fa-star"></i>
                                <i class="{% if rating >= 5 %}fas{% else %}far{% endif %} fa-star"></i>
                            {% endwith %}
                        </div>
                        <span class="rating-text">({{ product.get_total_reviews }})</span>
                    </div>
                    
                    <div class="pricing-wrapper">
                        {% if product.has_discount %}
                            <span class="modern-product-price">{{ product.get_price_with_offer }} {{ supplier.currency }}</span>
                            <span class="old-price">{{ product.price }} {{ supplier.currency }}</span>
                        {% else %}
                            <span class="modern-product-price">{{ product.price }} {{ supplier.currency }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="modern-product-actions">
                        {% with cart_item_qty=product.quantity_in_cart|default:0 %}
                            <div class="modern-quantity-controls {% if cart_item_qty == 0 %}d-none{% endif %}" id="qty-ctrl-{{ product.id }}" data-product-id="{{ product.id }}">
                                <button class="modern-qty-btn" onclick="subToCart('{{ product.id }}', '{{ supplier.id }}')">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="modern-qty-display" id="total-qty-items-{{ product.id }}">{{ cart_item_qty }}</span>
                                <button class="modern-qty-btn" onclick="addToCart('{{ product.id }}', '{{ supplier.id }}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <button class="modern-cart-btn-long {% if cart_item_qty > 0 %}d-none{% endif %}" id="add-btn-{{ product.id }}" onclick="addToCart('{{ product.id }}', '{{ supplier.id }}')">
                                <i class="fas fa-shopping-cart"></i>
                                <span>إضافة للسلة</span>
                            </button>
                        {% endwith %}
                    </div>
                </div>
                    
                    <!-- Social Share Menu (Hidden by default) -->
                    <div class="social-share-menu" id="share-menu-{{ product.id }}">
                        <button class="share-item whatsapp" onclick="shareWhatsApp('{{ product.name }}', '{{ product.id }}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-item facebook" onclick="shareFacebook('{{ product.id }}')">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="share-item copy" onclick="copyProductLink('{{ product.id }}')">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="modern-no-products">
        <i class="fas fa-box-open"></i>
        <h3>لا توجد منتجات متاحة</h3>
        <p class="text-muted">لم يتم العثور على أي منتجات في هذا المتجر</p>
    </div>
    {% endif %}
</div>
</div>

<!-- Floating Cart Button for Mobile -->
<a href="{% url 'cart-detail' supplier.id %}" class="floating-cart-btn d-lg-none">
    <i class="fas fa-shopping-cart fs-5"></i>
    <span class="floating-cart-badge">{{ cart.get_total_items }}</span>
</a>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    try {
        if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        } else {
            // If bootstrap not yet available, initialize on DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof bootstrap === 'undefined') return;
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            });
        }
    } catch (err) {
        console.warn('Tooltip initialization skipped:', err);
    }
    
    // Wishlist functionality with AJAX
    function toggleWishlist(productId) {
        const wishlistBtn = document.querySelector(`[data-product-id="${productId}"] .wishlist-btn`);
        const icon = wishlistBtn.querySelector('i');
        
        // Disable button during request
        wishlistBtn.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                         getCookie('csrftoken');
        
        // Make AJAX request
        fetch(`/wishlist/toggle/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.in_wishlist) {
                    wishlistBtn.classList.add('active');
                    icon.className = 'fas fa-heart';
                    showToast(data.message || 'تم إضافة المنتج للمفضلة', 'success');
                } else {
                    wishlistBtn.classList.remove('active');
                    icon.className = 'far fa-heart';
                    showToast(data.message || 'تم إزالة المنتج من المفضلة', 'info');
                }
            } else {
                showToast(data.message || 'حدث خطأ أثناء تحديث المفضلة', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('حدث خطأ في الاتصال', 'error');
        })
        .finally(() => {
            // Re-enable button
            wishlistBtn.disabled = false;
        });
    }
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Load initial wishlist status for all products
    function loadWishlistStatus() {
        const productCards = document.querySelectorAll('.modern-product-card');

        productCards.forEach(card => {
            const productId = card.getAttribute('data-product-id');
            const wishlistBtn = card.querySelector('.wishlist-btn');
            if (!productId || !wishlistBtn) return; // guard

            // ensure icon exists
            let icon = wishlistBtn.querySelector('i');
            if (!icon) {
                icon = document.createElement('i');
                icon.className = 'far fa-heart';
                wishlistBtn.appendChild(icon);
            }

            fetch(`/wishlist/status/${productId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.status === 401) {
                    // not authenticated (or backend returned 401) — stop here
                    return { success: false, login_required: true };
                }
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    // unexpected response (HTML redirect to login) — don't throw
                    return { success: false };
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success && data.in_wishlist) {
                    wishlistBtn.classList.add('active');
                    icon.className = 'fas fa-heart';
                } else {
                    wishlistBtn.classList.remove('active');
                    icon.className = 'far fa-heart';
                }
            })
            .catch(error => {
                console.error('Error loading wishlist status:', error);
            });
        });
    }
    
    // Quick view functionality
    function quickView(productId) {
        // Create and show quick view modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">عرض سريع للمنتج</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
        
        // Here you can add AJAX call to load product details
        setTimeout(() => {
            modal.querySelector('.modal-body').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <img src="/static/placeholder-product.jpg" class="img-fluid rounded" alt="Product">
                    </div>
                    <div class="col-md-6">
                        <h4>اسم المنتج</h4>
                        <p class="text-muted">وصف المنتج هنا...</p>
                        <h5 class="text-primary">299 {{ supplier.currency }}</h5>
                        <button class="btn btn-primary">إضافة للسلة</button>
                    </div>
                </div>
            `;
        }, 1000);
    }
    
    // Social sharing functions
    function shareWhatsApp(productName, productId) {
        const url = encodeURIComponent(window.location.origin + '/products/details/' + productId + '/');
        const text = encodeURIComponent(`شاهد هذا المنتج الرائع: ${productName}`);
        window.open(`https://wa.me/?text=${text} ${url}`, '_blank');
    }
    
    function shareFacebook(productId) {
        const url = encodeURIComponent(window.location.origin + '/products/details/' + productId + '/');
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }
    

    
    function copyProductLink(productId) {
        const url = window.location.origin + '/products/details/' + productId + '/';
        navigator.clipboard.writeText(url).then(() => {
            showToast('تم نسخ رابط المنتج', 'success');
        }).catch(() => {
            showToast('فشل في نسخ الرابط', 'error');
        });
    }
    
    function shareProduct(productId) {
        const menu = document.getElementById(`share-menu-${productId}`);
        if (menu) {
            menu.classList.toggle('active');
            
            // Auto-hide after 5 seconds
            if (menu.classList.contains('active')) {
                setTimeout(() => {
                    menu.classList.remove('active');
                }, 5000);
            }
        }
    }
    
    function compareProduct(productId) {
        showToast('تم إضافة المنتج للمقارنة', 'info');
        // Here you can add compare functionality
    }
    
    // Show login prompt for non-authenticated users
    function showLoginPrompt() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تسجيل الدخول مطلوب</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="fas fa-heart text-danger mb-3" style="font-size: 3rem;"></i>
                        <h4>سجل دخولك لإضافة المنتجات للمفضلة</h4>
                        <p class="text-muted">يمكنك حفظ منتجاتك المفضلة والوصول إليها في أي وقت بعد تسجيل الدخول</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <a href="{% url 'login' %}" class="btn btn-primary px-4">
                            <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
    
    // Pending Orders Sidebar Functions
    function togglePendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar.classList.contains('active')) {
            closePendingOrdersSidebar();
        } else {
            openPendingOrdersSidebar();
        }
    }
    
    function openPendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        sidebar.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closePendingOrdersSidebar() {
        const sidebar = document.getElementById('pendingOrdersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Close sidebar on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePendingOrdersSidebar();
            closeAllOrderMenus();
        }
    });
    
    // Dismiss notification functionality
    function dismissNotification(event) {
        event.stopPropagation();
        const notification = document.querySelector('.pending-orders-floating');
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.style.display = 'none', 300);
        localStorage.setItem('pendingOrdersDismissed', Date.now());
    }
    
    // Order menu functionality
    function toggleOrderMenu(orderId) {
        const menu = document.getElementById(`orderMenu${orderId}`);
        const isActive = menu.classList.contains('active');
        closeAllOrderMenus();
        if (!isActive) menu.classList.add('active');
    }
    
    function closeAllOrderMenus() {
        document.querySelectorAll('.order-menu-dropdown').forEach(menu => {
            menu.classList.remove('active');
        });
    }
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.order-menu')) closeAllOrderMenus();
    });
    
    // Order actions
    function duplicateOrder(orderId) {
        showToast(`جاري تكرار الطلب #${orderId}...`, 'info');
        setTimeout(() => showToast(`تم تكرار الطلب #${orderId} بنجاح`, 'success'), 1500);
        closeAllOrderMenus();
    }
    
    function editOrder(orderId) {
        showToast(`جاري فتح محرر الطلب #${orderId}...`, 'info');
        closeAllOrderMenus();
    }
    
    function trackOrder(orderId) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تتبع الطلب #${orderId}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                            <h6>تم إنشاء الطلب</h6>
                            <small class="text-muted">اليوم 10:30 ص</small>
                        </div>
                        <div class="mb-3">
                            <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                            <h6>في انتظار الدفع</h6>
                            <small class="text-muted">حالي</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => document.body.removeChild(modal));
        closeAllOrderMenus();
    }
    
    function cancelOrder(orderId) {
        if (confirm(`هل أنت متأكد من إلغاء الطلب #${orderId}؟`)) {
            showToast(`جاري إلغاء الطلب #${orderId}...`, 'info');
            setTimeout(() => {
                showToast(`تم إلغاء الطلب #${orderId} بنجاح`, 'success');
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    orderCard.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => orderCard.remove(), 500);
                }
            }, 1500);
        }
        closeAllOrderMenus();
    }
    
    function showPaymentOptions(orderId) {
        showToast('جاري فتح خيارات الدفع...', 'info');
    }
    
    // Search and filter initialization
    function initializeOrderSearch() {
        const searchInput = document.getElementById('orderSearchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toUpperCase();
                filterOrders(filter);
            });
        }
    }
    
    function initializeFilterTabs() {
        const filterTabs = document.querySelectorAll('.filter-tab');
        filterTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                filterTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const statusFilter = this.getAttribute('data-filter');
                filterOrders('', statusFilter);
            });
        });
    }
    
    function filterOrders(searchFilter, statusFilter = 'all') {
        const orderCards = document.querySelectorAll('.pending-order-card');
        let visibleCount = 0;
        
        orderCards.forEach(card => {
            const orderId = card.querySelector('.order-id').textContent.toUpperCase();
            const orderStatus = card.getAttribute('data-order-status') || 'pending';
            
            let shouldShow = true;
            
            if (searchFilter && !orderId.includes(searchFilter)) {
                shouldShow = false;
            }
            
            if (statusFilter !== 'all' && statusFilter !== orderStatus) {
                shouldShow = false;
            }
            
            card.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) visibleCount++;
        });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
    
    function loadCartStatus() {
        const supplierId = "{{ supplier.id }}";
        fetch(`/cart/status/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.items) {
                    data.items.forEach(item => {
                        const productId = item.product_id;
                        const quantity = item.quantity;
                        
                        const qtyCtrl = document.getElementById(`qty-ctrl-${productId}`);
                        const addBtn = document.getElementById(`add-btn-${productId}`);
                        const qtyDisplay = document.getElementById(`total-qty-items-${productId}`);
                        
                        if (qtyCtrl && addBtn && qtyDisplay && quantity > 0) {
                            qtyCtrl.classList.remove('d-none');
                            addBtn.classList.add('d-none');
                            qtyDisplay.textContent = quantity;
                        }
                    });
                    
                    // Update global cart counts if necessary
                    if (data.cart_items_count !== undefined) {
                        const cartCount = document.getElementById('total-items');
                        const cartCountMobile = document.getElementById('total-items-mobile');
                        if (cartCount) cartCount.textContent = data.cart_items_count;
                        if (cartCountMobile) cartCountMobile.textContent = data.cart_items_count;
                    }
                }
            })
            .catch(error => console.error('Error fetching cart status:', error));
    }

    // Enhanced animations for product cards
    document.addEventListener('DOMContentLoaded', function() {
        const productCards = document.querySelectorAll('.modern-product-card');
        
        // Load wishlist status for authenticated users
        {% if user.is_authenticated %}
        loadWishlistStatus();
        loadCartStatus();
        {% endif %}
        
        // Initialize pending orders features
        {% if pending_orders %}
        initializeOrderSearch();
        initializeFilterTabs();
        initializeModalHandling();
        {% endif %}
        
        // Intersection Observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);
        
        productCards.forEach((card) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });
        
        // Handle category collapse behavior
        const categoryButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
        categoryButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Close other open category panels
                const target = this.getAttribute('href');
                categoryButtons.forEach(btn => {
                    if (btn !== this && btn.getAttribute('href') !== '#pendingOrdersCollapse') {
                        const otherTarget = btn.getAttribute('href');
                        if (otherTarget && otherTarget.startsWith('#subcategory-')) {
                            const collapse = bootstrap.Collapse.getInstance(document.querySelector(otherTarget));
                            if (collapse) {
                                collapse.hide();
                            }
                        }
                    }
                });
            });
        });
        
        // Parallax effect for hero section
        if (document.querySelector('.modern-hero')) {
            window.addEventListener('scroll', function() {
                const scrolled = window.pageYOffset;
                const hero = document.querySelector('.modern-hero');
                if (hero) {
                    hero.style.backgroundPositionY = -(scrolled * 0.2) + 'px';
                }
            });
        }
    });
</script>
{% endblock %}