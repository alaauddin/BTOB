{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة الطلبات - {{ supplier.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/merchant_orders.css' %}">
<style>
    :root {
        --primary-color: {{ supplier.primary_color|default:'#ef7d2d' }};
        --secondary-color: {{ supplier.secondary_color|default:'#ffffff' }};
        --accent-color: {{ supplier.accent_color|default:'#9abfc4' }};
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="orders-container">
                <!-- Breadcrumbs & Header -->
                <div class="breadcrumb-container">
                    <ul class="breadcrumb-custom">
                        <li class="breadcrumb-item-custom">
                            <a href="{% url 'my_merchant' %}{% if request.GET.supplier_id %}?supplier_id={{ request.GET.supplier_id }}{% endif %}">لوحة التحكم</a>
                        </li>
                        <i class="fas fa-chevron-left breadcrumb-separator"></i>
                        <li class="breadcrumb-item-custom active">إدارة الطلبات</li>
                    </ul>
                </div>

                <div class="page-title-row">
                    <h2 class="page-title">
                        <i class="fas fa-shopping-cart"></i>
                        إدارة الطلبات
                    </h2>
                </div>

                <!-- Statistics Summary Row -->
                <div class="stats-summary-card">
                    <div class="stats-row">
                        <div class="stat-item">
                            <span class="stat-number">{{ total_orders }}</span>
                            <span class="stat-label">إجمالي الطلبات</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ pending_orders }}</span>
                            <span class="stat-label">طلبات معلقة</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ confirmed_orders }}</span>
                            <span class="stat-label">طلبات مؤكدة</span>
                        </div>
                        {% if supplier.show_order_amounts %}
                        <div class="stat-item">
                            <span class="stat-number">${{ total_revenue|floatformat:2 }}</span>
                            <span class="stat-label">إجمالي الإيرادات</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Innovative Filters -->
                <div class="filters-section">
                    <form method="get" id="filterForm" class="filter-form">
                        {% if request.GET.supplier_id %}
                            <input type="hidden" name="supplier_id" value="{{ request.GET.supplier_id }}">
                        {% endif %}
                        <input type="hidden" name="status" id="status_input" value="{{ status_filter|default:'' }}">

                        <!-- Status Tabs and Toggle -->
                        <div class="status-row-wrapper mb-2">
                            <div class="status-tabs-container">
                                <a href="javascript:void(0)" class="status-tab {% if not status_filter %}active{% endif %}" onclick="submitWithStatus('')">جميع الحالات</a>
                                {% for step in workflow_steps %}
                                    <a href="javascript:void(0)" class="status-tab {% if status_filter == step.status.slug %}active{% endif %}" onclick="submitWithStatus('{{ step.status.slug }}')">
                                        {{ step.status.name }}
                                    </a>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn-toggle-filter {% if search_query or date_from or date_to %}active{% endif %}" onclick="toggleFilters()" id="filterToggleBtn" title="بحث وتاريخ">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <!-- Collapsible Search and Date Row -->
                        <div id="collapsibleFilters" class="collapsible-filter-content {% if search_query or date_from or date_to %}show{% endif %}">
                            <div class="compact-filter-row">
                                <div class="filter-input-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" name="search" placeholder="رقم الطلب أو اسم العميل" value="{{ search_query }}">
                                </div>
                                
                                <div class="date-range-group">
                                    <div class="date-input-wrapper">
                                        <i class="fas fa-calendar-alt"></i>
                                        <input type="date" name="date_from" value="{{ date_from }}" title="من تاريخ">
                                    </div>
                                    <span class="text-gray-400"> إلى </span>
                                    <div class="date-input-wrapper">
                                        <i class="fas fa-calendar-alt"></i>
                                        <input type="date" name="date_to" value="{{ date_to }}" title="إلى تاريخ">
                                    </div>
                                </div>

                                <button type="submit" class="btn-filter-compact">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <script>
                function submitWithStatus(status) {
                    document.getElementById('status_input').value = status;
                    document.getElementById('filterForm').submit();
                }

                function toggleFilters() {
                    const content = document.getElementById('collapsibleFilters');
                    const btn = document.getElementById('filterToggleBtn');
                    content.classList.toggle('show');
                    btn.classList.toggle('active');
                }

                function showNotification(message, type = 'success') {
                    const toast = document.createElement('div');
                    toast.className = `custom-toast toast-${type}`;
                    toast.innerHTML = `
                        <div class="toast-content">
                            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.classList.add('show');
                        setTimeout(() => {
                            toast.classList.remove('show');
                            setTimeout(() => toast.remove(), 400);
                        }, 3000);
                    }, 100);
                }
                </script>

                <!-- Orders Table -->
                <div class="orders-table-wrapper">
                    <div class="table-header">
                        <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-list me-2"></i>قائمة الطلبات</h3>
                        <span class="text-sm text-gray-500">{{ page_obj.paginator.count }} طلب</span>
                    </div>
                    
                    {% if page_obj %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th class="col-id">رقم الطلب</th>
                                        <th>العميل</th>
                                        <th class="desktop-only">التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>الحالة</th>
                                        <th class="col-actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in page_obj %}
                                    <tr>
                                        <td class="col-id"><span class="font-bold">#{{ order.id }}</span></td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="font-medium client-name-wrapper" title="{{ order.user.get_full_name|default:order.user.username }}">{{ order.user.get_full_name|default:order.user.username }}</span>
                                                <span class="text-xs text-gray-400 mobile-only" style="margin-top: 0.15rem; font-size: 0.65rem;">{{ order.created_at|date:"Y/m/d H:i" }}</span>
                                            </div>
                                        </td>
                                        <td class="desktop-only text-gray-500">{{ order.created_at|date:"Y/m/d H:i" }}</td>
                                        <td class="font-bold">{{ order.total_amount|floatformat:2 }} {{ supplier.currency }}</td>
                                        <td>
                                            <span class="status-badge status-{{ order.pipeline_status.slug }}">
                                                {{ order.pipeline_status.name }}
                                            </span>
                                        </td>
                                        <td class="col-actions">
                                            <div class="d-flex gap-1 justify-content-center">
                                                {% with address=order.shippingaddress_set.first %}
                                                    {% if address %}
                                                        <a href="https://wa.me/{{ address.phone|default:order.user.username }}?text=مرحباً {{ order.user.get_full_name|default:'عزيزي' }}، معك {{ supplier.name }}. بخصوص طلبك رقم {{ order.id }}..." target="_blank" class="btn-whatsapp-mobile" title="مراسلة العميل">
                                                            <i class="fab fa-whatsapp"></i>
                                                        </a>
                                                    {% endif %}
                                                {% endwith %}
                                                
                                                <button type="button" onclick="openOrderQuickView({{ order.id }})" class="btn-details" title="عرض سريع">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if page_obj.has_other_pages %}
                        <div class="pagination-section">
                            <div class="pagination-container">
                                {% if page_obj.has_previous %}
                                    <a href="?page=1{% if request.GET.supplier_id %}&supplier_id={{ request.GET.supplier_id }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                                       class="pagination-btn">
                                        <i class="fas fa-angles-right"></i>
                                    </a>
                                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.supplier_id %}&supplier_id={{ request.GET.supplier_id }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                                       class="pagination-btn">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                {% endif %}

                                <div class="pagination-pages">
                                    {% for i in page_obj.paginator.page_range %}
                                        {% if page_obj.number == i %}
                                            <span class="pagination-btn active">{{ i }}</span>
                                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                                            <a href="?page={{ i }}{% if request.GET.supplier_id %}&supplier_id={{ request.GET.supplier_id }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                                               class="pagination-btn">{{ i }}</a>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.supplier_id %}&supplier_id={{ request.GET.supplier_id }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                                       class="pagination-btn">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.supplier_id %}&supplier_id={{ request.GET.supplier_id }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                                       class="pagination-btn">
                                        <i class="fas fa-angles-left"></i>
                                    </a>
                                {% endif %}
                            </div>
                            <span class="pagination-info">
                                صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
                            </span>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="no-orders">
                            <i class="fas fa-shopping-cart"></i>
                            <h4>لا توجد طلبات</h4>
                            <p>لم يتم العثور على أي طلبات تطابق معايير البحث</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick View Modal -->
<div id="quickViewModal" class="modal-overlay hidden" onclick="closeOrderQuickView(event)">
    <div class="quick-view-modal" onclick="event.stopPropagation()">
        <div class="modal-header-premium">
            <div class="header-info">
                <span id="modalOrderId" class="order-number">#---</span>
                <h3 id="modalCustomerName" class="customer-name">جاري التحميل...</h3>
                <p id="modalCustomerAddress" class="customer-address"></p>
            </div>
            <button type="button" class="btn-close-modal" onclick="closeOrderQuickView()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Mini Stepper Container -->
            <div id="modalOrderStepper" class="mini-pipeline-wrapper hidden">
                <div class="mini-pipeline-stepper" id="stepperItems">
                    <!-- Steps injected here -->
                </div>
            </div>

            <div class="order-items-scroll">
                <table class="quick-items-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th class="text-center">الكمية</th>
                            <th class="text-end">السعر</th>
                            <th class="text-end">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="modalOrderItems">
                        <!-- Items injected here -->
                    </tbody>
                </table>
            </div>
            
            <div class="modal-summary">
                <div class="summary-item">
                    <span>المجموع:</span>
                    <span id="modalSubtotal">0.00 {{ supplier.currency }}</span>
                </div>
                <div id="modalDiscountRow" class="summary-item text-success hidden">
                    <span>الخصم:</span>
                    <span id="modalDiscount">- 0.00 {{ supplier.currency }}</span>
                </div>
                <div id="modalDeliveryRow" class="summary-item hidden">
                    <span>التوصيل:</span>
                    <span id="modalDelivery">+ 0.00 {{ supplier.currency }}</span>
                </div>
                <div class="summary-total">
                    <span>الإجمالي الكلي:</span>
                    <span id="modalOrderTotal">0.00 {{ supplier.currency }}</span>
                </div>
            </div>
        </div>
        
        <div class="modal-footer-premium">
            <div class="action-grid">
                <a id="modalWhatsApp" href="#" target="_blank" class="action-btn btn-whatsapp">
                    <div class="icon-circle"><i class="fab fa-whatsapp"></i></div>
                    <span>واتساب</span>
                </a>
                <a id="modalCall" href="#" class="action-btn btn-call">
                    <div class="icon-circle"><i class="fas fa-phone-alt"></i></div>
                    <span>اتصال</span>
                </a>
                <a id="modalMap" href="#" target="_blank" class="action-btn btn-map">
                    <div class="icon-circle"><i class="fas fa-map-marked-alt"></i></div>
                    <span>الموقع</span>
                </a>
                <a id="modalDetails" href="#" class="action-btn btn-view-full">
                    <div class="icon-circle"><i class="fas fa-external-link-alt"></i></div>
                    <span>التفاصيل</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function openOrderQuickView(orderId) {
    const modal = document.getElementById('quickViewModal');
    const itemsContainer = document.getElementById('modalOrderItems');
    
    // Reset modal state
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent scroll
    itemsContainer.innerHTML = '<tr><td colspan="4" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>جاري تحميل تفاصيل الطلب...</td></tr>';
    document.getElementById('modalOrderStepper').classList.add('hidden');
    
    // Icon mapping helper
    const getStatusIcon = (slug) => {
        const icons = {
            'pending': 'fa-clock',
            'confirmed': 'fa-check',
            'processing': 'fa-cog fa-spin',
            'shipped': 'fa-truck',
            'delivered': 'fa-box-open'
        };
        return icons[slug] || 'fa-flag-checkered';
    };

    // Fetch order data
    fetch(`/merchant-order-quick-view/${orderId}/{% if request.GET.supplier_id %}?supplier_id={{ request.GET.supplier_id }}{% endif %}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const order = data.order;
                
                // Update header
                document.getElementById('modalOrderId').textContent = `#${order.id}`;
                document.getElementById('modalCustomerName').textContent = order.customer_name;
                document.getElementById('modalCustomerAddress').textContent = order.contact.address || 'العنوان غير متوفر';
                
                // Update Stepper
                if (order.workflow_steps && order.workflow_steps.length > 0) {
                    const stepperItems = document.getElementById('stepperItems');
                    stepperItems.innerHTML = order.workflow_steps.map(step => {
                        let statusClass = '';
                        if (order.status.toLowerCase() === step.name.toLowerCase() || order.status.toLowerCase() === step.slug.toLowerCase()) {
                            // Note: we might need a better way to check active status if names differ from slugs
                            // Using the slug from backend is safer. 
                        }
                        
                        // Using priority logic from backend
                        if (order.current_priority === step.priority) statusClass = 'active';
                        else if (step.priority < order.current_priority) statusClass = 'completed';
                        
                        return `
                        <div class="mini-step-item ${statusClass}" onclick="changeOrderStepperStatus(${order.id}, '${step.slug}')" style="cursor: pointer;" title="تحويل إلى ${step.name}">
                            <div class="mini-step-icon">
                                <i class="fas ${getStatusIcon(step.slug)}"></i>
                            </div>
                            <span class="mini-step-label">${step.name}</span>
                        </div>
                        `;
                    }).join('');
                    document.getElementById('modalOrderStepper').classList.remove('hidden');
                }

                // Update items
                itemsContainer.innerHTML = order.items.map(item => `
                    <tr>
                        <td><div class="item-name">${item.name}</div></td>
                        <td class="text-center"><span class="item-qty">x${item.quantity}</span></td>
                        <td class="text-end font-medium">${item.price.toFixed(2)}</td>
                        <td class="text-end font-bold">${item.subtotal.toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // Update total
                document.getElementById('modalSubtotal').textContent = `${order.subtotal.toFixed(2)} {{ supplier.currency }}`;
                
                const discountRow = document.getElementById('modalDiscountRow');
                if (order.discount_amount > 0) {
                    document.getElementById('modalDiscount').textContent = `- ${order.discount_amount.toFixed(2)} {{ supplier.currency }}`;
                    discountRow.classList.remove('hidden');
                } else {
                    discountRow.classList.add('hidden');
                }
                
                const deliveryRow = document.getElementById('modalDeliveryRow');
                if (order.delivery_fee > 0) {
                    document.getElementById('modalDelivery').textContent = `+ ${order.delivery_fee.toFixed(2)} {{ supplier.currency }}`;
                    deliveryRow.classList.remove('hidden');
                } else {
                    deliveryRow.classList.add('hidden');
                }
                
                document.getElementById('modalOrderTotal').textContent = `${order.total_amount.toFixed(2)} {{ supplier.currency }}`;
                
                // Update action buttons
                const phone = order.contact.phone;
                const whatsappMsg = `مرحباً ${order.customer_name}، معك {{ supplier.name }}. بخصوص طلبك رقم ${order.id}...`;
                
                const waBtn = document.getElementById('modalWhatsApp');
                if (phone) {
                    waBtn.href = `https://wa.me/${phone}?text=${encodeURIComponent(whatsappMsg)}`;
                    waBtn.style.display = 'flex';
                } else {
                    waBtn.style.display = 'none';
                }
                
                const callBtn = document.getElementById('modalCall');
                if (phone) {
                    callBtn.href = `tel:${phone}`;
                    callBtn.style.display = 'flex';
                } else {
                    callBtn.style.display = 'none';
                }
                
                const mapBtn = document.getElementById('modalMap');
                if (order.contact.lat && order.contact.lng) {
                    mapBtn.href = `https://www.google.com/maps/search/?api=1&query=${order.contact.lat},${order.contact.lng}`;
                    mapBtn.style.display = 'flex';
                } else {
                    mapBtn.style.display = 'none';
                }
                
                document.getElementById('modalDetails').href = order.details_url + '{% if request.GET.supplier_id %}?supplier_id={{ request.GET.supplier_id }}{% endif %}';
            } else {
                showNotification(data.message || 'حدث خطأ أثناء تحميل تفاصيل الطلب', 'error');
                closeOrderQuickView();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('حدث خطأ في الاتصال بالخادم', 'error');
            closeOrderQuickView();
        });
}

function closeOrderQuickView(event) {
    if (event && event.target !== document.getElementById('quickViewModal')) return;
    document.getElementById('quickViewModal').classList.add('hidden');
    document.body.style.overflow = ''; // Restore scroll
}

function changeOrderStepperStatus(orderId, statusSlug) {
    // Show confirmation or just proceed? Usually for quick view, simple confirmation or instant is fine.
    // Instant update with loading state is better for premium feel.
    
    const stepperWrapper = document.getElementById('modalOrderStepper');
    const originalContent = stepperWrapper.innerHTML;
    
    // Show minimal loading state on the stepper
    stepperWrapper.style.opacity = '0.5';
    stepperWrapper.style.pointerEvents = 'none';

    const formData = new FormData();
    formData.append('status', statusSlug);
    {% if request.GET.supplier_id %}
    formData.append('supplier_id', '{{ request.GET.supplier_id }}');
    {% endif %}

    fetch(`/update-order-status-ajax/${orderId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            // Refresh modal data to update UI
            openOrderQuickView(orderId);
            
            // Refresh the main table row status badge without page reload
            document.querySelectorAll('tr').forEach(row => {
                const idCell = row.querySelector('.col-id');
                if (idCell && idCell.textContent.trim() === `#${orderId}`) {
                    const badge = row.querySelector('.status-badge');
                    if (badge) {
                        badge.textContent = data.new_status;
                        badge.className = `status-badge status-${data.new_slug}`;
                    }
                }
            });
        } else {
            showNotification(data.message || 'حدث خطأ في تحديث الحالة', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('حدث خطأ في الاتصال بالخادم', 'error');
    })
    .finally(() => {
        stepperWrapper.style.opacity = '1';
        stepperWrapper.style.pointerEvents = 'auto';
    });
}
</script>
{% endblock %}

{% block footer %}
<!-- Premium Compact Merchant Footer -->
<footer class="merchant-footer">
    <div class="container mx-auto px-6">
        <div class="merchant-footer-content">
            <div class="merchant-footer-links">
                <a href="#">من نحن</a>
                <a href="#">الشروط والأحكام</a>
                <a href="#">سياسة الخصوصية</a>
            </div>
            
            <div class="merchant-footer-info">
                <span>© {% now "Y" %} {{ system_settings.site_name }}</span>
                {% if supplier.profile_picture %}
                    <img src="{{ supplier.profile_picture.url }}" alt="{{ supplier.name }}" class="merchant-footer-logo">
                {% endif %}
                <span>جميع الحقوق محفوظة</span>
            </div>
        </div>
    </div>
</footer>
{% endblock %}

