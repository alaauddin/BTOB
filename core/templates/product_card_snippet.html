<div class="col animate-fade-in-up" style="animation-delay: {{ forloop.counter0|divisibleby:4|yesno:'0,0.1,0.2,0.3' }}s">
    <div class="store-card" data-product-id="{{ product.id }}">
        
        <!-- Image Area -->
        <div class="card-image-wrapper">
            <a href="{% url 'product_canonical' store_slug=supplier.store_id pk=product.pk %}" class="d-block w-100 h-100">
                <img src="{{ product.image.url }}" class="card-img" alt="{{ product.name }}" loading="lazy">
            </a>
            
            <!-- Badges Groups (Top Left) -->
            <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-1 z-2">
                {% if product.stock <= 0 %}
                <span class="badge bg-dark bg-opacity-75 backdrop-blur-sm rounded-pill font-weight-normal px-2">نفذت الكمية</span>
                {% elif product.stock < 5 %}
                <span class="badge bg-warning text-dark rounded-pill font-weight-bold px-2">كمية محدودة</span>
                {% endif %}
                
                {% if product.has_discount %}
                    {% with discount=product.get_discount_precentage %}
                    <span class="badge bg-danger rounded-pill px-2">
                        <i class="fas fa-fire me-1"></i> -{{ discount }}%
                    </span>
                    {% endwith %}
                {% elif product.is_new %}
                <span class="badge bg-primary rounded-pill px-2">جديد</span>
                {% endif %}
            </div>
            
            <!-- Wishlist (Top Right) -->
            <!-- Authenticated Check handled by JS/click event if complicated, but simple toggle here -->
            {% if user.is_authenticated %}
            <button type="button" class="wishlist-btn-float" onclick="toggleWishlist({{ product.id }}, event)" aria-label="Add to wishlist">
                <i class="far fa-heart"></i>
            </button>
            {% else %}
            <button type="button" class="wishlist-btn-float" onclick="window.location.href='{% url 'login' %}'" aria-label="Login for wishlist">
                <i class="far fa-heart"></i>
            </button>
            {% endif %}
            
            <!-- Media Indicators (Bottom Left) -->
            <div class="position-absolute bottom-0 start-0 p-2 d-flex gap-1 z-2">
                {% if product.video %}
                <div class="bg-dark bg-opacity-50 text-white rounded p-1 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                    <i class="fas fa-video fa-xs"></i>
                </div>
                {% endif %}
                {% if product.additional_images.exists %}
                <div class="bg-dark bg-opacity-50 text-white rounded p-1 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                    <i class="fas fa-images fa-xs"></i>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Content Area -->
        <div class="card-content">
            <div class="prod-category">{{ product.category.name }}</div>
            
            <h3 class="prod-title">
                <a href="{% url 'product_canonical' store_slug=supplier.store_id pk=product.pk %}" class="text-decoration-none text-reset">
                    {{ product.name }}
                </a>
            </h3>
            
            <!-- Price Row -->
            <div class="price-row mb-3">
                {% if product.has_discount %}
                    <span class="current-price">{{ product.get_price_with_offer|floatformat:0 }} <small class="fs-7 fw-normal">{{ supplier.currency }}</small></span>
                    <span class="old-price">{{ product.price|floatformat:0 }}</span>
                {% else %}
                    <span class="current-price">{{ product.price|floatformat:0 }} <small class="fs-7 fw-normal">{{ supplier.currency }}</small></span>
                {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="mt-auto">
                {% with cart_item_qty=product.quantity_in_cart|default:0 %}
                
                <!-- Quantity Controls (If in cart) -->
                <div class="d-flex align-items-center justify-content-between bg-light rounded-pill p-1 {% if cart_item_qty == 0 %}d-none{% endif %}" 
                     id="qty-ctrl-{{ product.id }}" 
                     style="border: 1px solid var(--surface-3);">
                    
                    <button type="button" class="btn btn-sm btn-white rounded-circle shadow-sm d-flex align-items-center justify-content-center p-0" 
                            style="width: 32px; height: 32px;"
                            onclick="subToCart('{{ product.id }}', '{{ supplier.store_id }}', event)">
                        <i class="fas fa-minus fs-7"></i>
                    </button>
                    
                    <span class="fw-bold px-2" id="total-qty-items-{{ product.id }}">{{ cart_item_qty }}</span>
                    
                    <button type="button" class="btn btn-sm btn-white rounded-circle shadow-sm d-flex align-items-center justify-content-center p-0" 
                            style="width: 32px; height: 32px;"
                            onclick="addToCart('{{ product.id }}', '{{ supplier.store_id }}', event)"
                            {% if product.stock <= cart_item_qty %}disabled style="opacity: 0.5"{% endif %}>
                        <i class="fas fa-plus fs-7"></i>
                    </button>
                </div>

                <!-- Add Button (If NOT in cart) -->
                {% if product.stock > 0 %}
                <button type="button" class="btn-add-cart {% if cart_item_qty > 0 %}d-none{% endif %}" 
                        id="add-btn-{{ product.id }}" 
                        onclick="addToCart('{{ product.id }}', '{{ supplier.store_id }}', event)">
                    <i class="fas fa-shopping-bag"></i>
                    إضافة
                </button>
                {% else %}
                <button class="btn btn-light w-100 rounded-pill py-2 text-muted fw-bold small" disabled>
                    غير متوفر
                </button>
                {% endif %}
                
                {% endwith %}
            </div>
        </div>
    </div>
</div>
