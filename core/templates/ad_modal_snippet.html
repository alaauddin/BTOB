<!-- Ad Management Modal -->
<div id="ad-modal" class="fixed inset-0 hidden" style="z-index: 99999;">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="closeAdModal()"></div>
    
    <!-- Modal container -->
    <div class="fixed inset-0 overflow-y-auto" style="z-index: 100000;">
        <div class="flex min-h-full items-center justify-center p-3 text-center sm:p-0">
            <!-- Modal Box -->
            <div class="relative transform overflow-hidden rounded-[2rem] bg-white text-right shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-white" onclick="event.stopPropagation()">
                
                <!-- Modal Header -->
                <div class="flex items-center justify-between border-b border-slate-50 p-5 bg-white sticky top-0 z-10">
                    <div class="flex flex-col">
                        <h2 class="text-lg font-black text-slate-800 flex items-center gap-2.5" id="ad-modal-title">
                            <span class="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-500">
                                <i class="fas fa-bullhorn text-lg"></i>
                            </span>
                            إضافة إعلان جديد
                        </h2>
                    </div>
                    <button onclick="closeAdModal()" class="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="p-6">
                    <form id="adForm" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="ad_id" id="edit-ad-id">
                        <input type="hidden" name="supplier_id" value="{{ supplier.id }}">
                        <input type="hidden" name="is_active" id="id_is_active_hidden" value="on">
                        
                        <!-- Compact Grid -->
                        <div class="modal-compact-grid">
                            <!-- Title -->
                            <div class="sm:col-span-2 premium-input-wrapper">
                                <label class="premium-label">
                                    <i class="fas fa-heading"></i>
                                    عنوان الإعلان
                                </label>
                                <input type="text" name="title" id="id_title" class="premium-input" placeholder="مثلاً: خصم 50% على جميع المنتجات" required>
                                <p class="hidden text-red-500 text-[10px] mt-1 font-bold error-message" id="title-error"></p>
                            </div>

                            <!-- Description -->
                            <div class="sm:col-span-2 premium-input-wrapper">
                                <label class="premium-label">
                                    <i class="fas fa-align-right"></i>
                                    وصف الإعلان
                                </label>
                                <textarea name="description" id="id_description" rows="3" class="premium-input resize-none" placeholder="اكتب تفاصيل الإعلان هنا..." required></textarea>
                                <p class="hidden text-red-500 text-[10px] mt-1 font-bold error-message" id="description-error"></p>
                            </div>

                            <!-- Linked Product -->
                            <div class="sm:col-span-2 premium-input-wrapper">
                                <label class="premium-label">
                                    <i class="fas fa-link"></i>
                                    المنتج المرتبط (اختياري)
                                </label>
                                <div class="premium-select-wrapper">
                                    <select name="product" id="id_product" class="premium-input premium-select appearance-none bg-none">
                                        <option value="">بدون منتج</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <p class="hidden text-red-500 text-[10px] mt-1 font-bold error-message" id="product-error"></p>
                            </div>


                            <!-- Image Upload -->
                            <div class="sm:col-span-2 premium-input-wrapper">
                                <label class="premium-label">
                                    <i class="fas fa-image"></i>
                                    صورة الإعلان
                                </label>
                                <div class="relative">
                                    <input type="file" name="image" id="id_image" class="hidden" accept="image/*" onchange="previewAdImage(this)">
                                    <label for="id_image" class="upload-card-premium block w-full">
                                        <div id="ad-upload-content" class="flex flex-col items-center justify-center py-8">
                                            <div class="upload-icon-box">
                                                <i class="fas fa-cloud-upload-alt text-xl"></i>
                                            </div>
                                            <p class="text-[11px] font-black text-slate-700">انقر لرفع صورة الإعلان</p>
                                            <p class="text-[9px] font-bold text-slate-400 mt-1">PNG, JPG up to 5MB</p>
                                        </div>
                                        
                                        <!-- Preview Container -->
                                        <div id="ad-preview-container" class="hidden absolute inset-0 bg-white">
                                            <img id="ad-image-preview" src="" class="w-full h-full object-cover">
                                            <div class="premium-preview-overlay">
                                                <div class="w-11 h-11 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-white border border-white/30 shadow-xl">
                                                    <i class="fas fa-sync-alt text-sm"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- Clear Action -->
                                    <button type="button" id="clearAdImage" onclick="removeAdImage()" class="hidden absolute top-2.5 left-2.5 w-8 h-8 bg-red-500/90 backdrop-blur shadow-lg shadow-red-500/20 text-white rounded-xl flex items-center justify-center hover:bg-red-600 transition-all z-20">
                                        <i class="fas fa-trash-alt text-[10px]"></i>
                                    </button>
                                </div>
                                <p class="hidden text-red-500 text-[10px] mt-1 font-bold error-message" id="image-error"></p>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="flex gap-3 mt-8 pt-5 border-t border-slate-50">
                            <button type="submit" id="adSubmitBtn" class="flex-[3] btn-premium btn-premium-primary">
                                <div class="loading-spinner hidden w-4 h-4 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                                <span id="adSubmitBtnText">حفظ الإعلان</span>
                            </button>
                            <button type="button" onclick="closeAdModal()" class="flex-[1] btn-premium btn-premium-secondary">
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function closeAdModal() {
        document.getElementById('ad-modal').classList.add('hidden');
        resetAdModal();
    }

    function resetAdModal() {
        document.getElementById('adForm').reset();
        document.getElementById('edit-ad-id').value = '';
        document.getElementById('id_is_active_hidden').value = 'on';
        removeAdImage();
        
        // Reset errors if any
        document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
    }

    function previewAdImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('ad-image-preview');
                const container = document.getElementById('ad-preview-container');
                const content = document.getElementById('ad-upload-content');
                const closeBtn = document.getElementById('clearAdImage');
                
                preview.src = e.target.result;
                container.classList.remove('hidden');
                content.classList.add('hidden');
                closeBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeAdImage() {
        const input = document.getElementById('id_image');
        const preview = document.getElementById('ad-image-preview');
        const container = document.getElementById('ad-preview-container');
        const content = document.getElementById('ad-upload-content');
        const closeBtn = document.getElementById('clearAdImage');
        
        input.value = '';
        preview.src = '';
        container.classList.add('hidden');
        content.classList.remove('hidden');
        closeBtn.classList.add('hidden');
    }

    // AJAX Form Submission
    document.getElementById('adForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('adSubmitBtn');
        const spinner = btn.querySelector('.loading-spinner');
        const text = document.getElementById('adSubmitBtnText');
        const formData = new FormData(this);
        const adId = document.getElementById('edit-ad-id').value;
        
        // Determine URL
        const url = adId ? `/edit-ad/${adId}/` : '/add-ad/';
        
        // UI Feedback
        spinner.classList.remove('hidden');
        text.textContent = 'جاري الحفظ...';
        btn.disabled = true;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (typeof showNotification === 'function') {
                    showNotification(data.message, 'success');
                } else {
                    alert(data.message);
                }
                setTimeout(() => location.reload(), 1000);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'حدث خطأ ما', 'error');
                } else {
                    alert(data.message || 'حدث خطأ ما');
                }
                
                // Show errors if any
                if (data.errors) {
                    Object.keys(data.errors).forEach(key => {
                        const errorEl = document.getElementById(`${key}-error`);
                        if (errorEl) {
                            errorEl.textContent = data.errors[key];
                            errorEl.classList.remove('hidden');
                        }
                    });
                }
            }
        })
        .catch(err => {
            console.error('Error:', err);
            if (typeof showNotification === 'function') {
                showNotification('حدث خطأ في الاتصال بالخادم', 'error');
            }
        })
        .finally(() => {
            spinner.classList.add('hidden');
            text.textContent = adId ? 'حفظ التعديلات' : 'حفظ الإعلان';
            btn.disabled = false;
        });
    });
</script>
