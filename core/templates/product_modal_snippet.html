{% load static %}

<!-- Unified Product Modal -->
<div id="product-modal" class="fixed inset-0 hidden" style="z-index: 99999;">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeProductModal()"></div>
    <div class="fixed inset-0 overflow-y-auto" style="z-index: 100000;">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-right shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-white/20">
                
                <!-- Modal Header -->
                <div class="flex items-center justify-between border-b border-slate-100 p-3 bg-white/80 backdrop-blur-md sticky top-0 z-10">
                    <h3 class="text-base font-black text-slate-800" id="modal-title">إضافة منتج جديد</h3>
                    <button onclick="closeProductModal()" class="rounded-full p-1.5 text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-colors">
                        <i class="fas fa-times text-base"></i>
                    </button>
                </div>
                
                <style>
                    /* Compact overrides for modal form fields and layout */
                    .modal-compact-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 0.5rem 0.75rem;
                    }
                    @media (max-width: 640px) {
                        .modal-compact-grid {
                            grid-template-columns: 1fr;
                            gap: 0.5rem;
                        }
                    }
                    #productForm input[type="text"], 
                    #productForm input[type="number"], 
                    #productForm select,
                    #productForm textarea {
                        padding: 0.4rem 0.6rem !important;
                        font-size: 0.75rem !important;
                        border-radius: 0.6rem !important;
                        background: #f8fafc !important;
                        border: 1px solid #e2e8f0 !important;
                    }
                    #productForm label.form-label {
                        font-size: 0.7rem !important;
                        margin-bottom: 0.15rem !important;
                        color: #64748b !important;
                        font-weight: 700 !important;
                    }
                    .compact-upload-row {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 0.5rem;
                    }
                    @media (max-width: 640px) {
                        .compact-upload-row {
                            grid-template-columns: 1fr;
                        }
                    }
                    .file-input-wrapper-mini {
                        border: 2px dashed #e2e8f0;
                        border-radius: 0.75rem;
                        padding: 0.5rem;
                        text-align: center;
                        position: relative;
                        transition: all 0.2s;
                        cursor: pointer;
                        background: white;
                    }
                    .file-input-wrapper-mini:hover {
                        border-color: #3b82f6;
                        background: #eff6ff;
                    }
                </style>

                <div class="p-3 bg-white">
                    <form id="productForm" method="post" enctype="multipart/form-data" novalidate class="flex flex-col gap-2">
                        {% csrf_token %}
                        <input type="hidden" id="edit-product-id" name="product_id">
                        <input type="hidden" name="supplier_id" value="{{ supplier.id }}">

                        <div class="modal-compact-grid">
                            <!-- Name -->
                            <div class="form-group col-span-1 sm:col-span-2">
                                <label class="form-label block">
                                    <i class="fas fa-tag text-blue-500 ml-1"></i>
                                    {{ product_form.name.label }}
                                </label>
                                {{ product_form.name }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="name-error"></div>
                            </div>

                            <!-- Category -->
                            <div class="form-group">
                                <div class="flex justify-between items-center mb-0.5">
                                    <label class="form-label block mb-0">
                                        <i class="fas fa-layer-group text-blue-500 ml-1"></i>
                                        {{ product_form.category.label }}
                                    </label>
                                    {% if supplier.can_add_product_categories or user.is_superuser %}
                                    <button type="button" onclick="openCategoryModal()" class="text-[9px] font-bold text-blue-600 hover:text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded-full">
                                        + جديد
                                    </button>
                                    {% endif %}
                                </div>
                                {{ product_form.category }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="category-error"></div>
                            </div>

                            <!-- Price -->
                            <div class="form-group">
                                <label class="form-label block">
                                    <i class="fas fa-coins text-blue-500 ml-1"></i>
                                    {{ product_form.price.label }}
                                </label>
                                {{ product_form.price }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="price-error"></div>
                            </div>

                            <!-- Description -->
                            <div class="form-group col-span-1 sm:col-span-2">
                                <label class="form-label block">
                                    <i class="fas fa-align-left text-blue-500 ml-1"></i>
                                    {{ product_form.description.label }}
                                </label>
                                {{ product_form.description }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="description-error"></div>
                            </div>
                        </div>

                        <!-- Mini Uploaders Row -->
                        <div class="compact-upload-row">
                            <!-- Main Image -->
                            <div class="form-group">
                                <label class="form-label block">
                                    <i class="fas fa-image text-blue-500 ml-1"></i>
                                    الصورة
                                </label>
                                <div class="file-input-wrapper-mini overflow-hidden group" id="modalFileWrapper">
                                    <input type="file" name="image" id="id_image" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*">
                                    <div id="modalFileUploadContent" class="pointer-events-none">
                                        <i class="fas fa-cloud-upload-alt text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[9px] text-slate-400">اختر صورة</p>
                                    </div>
                                    <div id="modalFilePreview" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center p-1">
                                        <img id="modalPreviewImage" src="" class="w-full h-full object-cover rounded-lg">
                                        <button type="button" id="clearFileBtn" class="absolute top-1 right-1 bg-white/80 backdrop-blur-sm text-red-500 rounded-full w-5 h-5 flex items-center justify-center shadow-sm">
                                            <i class="fas fa-times text-[10px]"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="image-error"></div>
                            </div>

                            <!-- Additional Images -->
                            <div class="form-group">
                                <label class="form-label block">
                                    <i class="fas fa-images text-blue-500 ml-1"></i>
                                    صور إضافية
                                </label>
                                <div class="file-input-wrapper-mini overflow-hidden">
                                    <input type="file" name="additional_images" id="id_additional_images" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" multiple accept="image/*">
                                    <div class="pointer-events-none">
                                        <i class="fas fa-plus-square text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[9px] text-slate-400">إضافة صور</p>
                                    </div>
                                    <div id="additional-images-count" class="hidden absolute top-1 right-1 bg-blue-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-sm z-20">0</div>
                                </div>
                            </div>

                            <!-- Video Upload -->
                            <div class="form-group">
                                <label class="form-label block">
                                    <i class="fas fa-video text-blue-500 ml-1"></i>
                                    فيديو
                                </label>
                                <div class="file-input-wrapper-mini overflow-hidden" id="modalVideoWrapper">
                                    <input type="file" name="video" id="id_video" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="video/*">
                                    <div id="modalVideoUploadContent" class="pointer-events-none">
                                        <i class="fas fa-film text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[10px] text-slate-400">اختر فيديو</p>
                                    </div>
                                    <div id="modalVideoPreview" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center">
                                        <i class="fas fa-check-circle text-emerald-500 text-xl"></i>
                                        <p class="text-[9px] text-slate-600 mt-1 font-bold">تم الاختيار</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="flex items-center justify-between pt-2 border-t border-slate-100 mt-1">
                            <div class="form-group flex items-center">
                                <label class="checkbox-wrapper flex items-center gap-2 cursor-pointer">
                                    {{ product_form.is_new }}
                                    <span class="text-[10px] font-bold text-slate-500">
                                        منتج جديد؟
                                    </span>
                                </label>
                            </div>
                            
                            <div class="flex gap-2">
                                <button type="button" id="modalDeleteBtn" class="px-3 py-1.5 bg-red-50 text-red-500 rounded-lg font-bold text-xs hover:bg-red-100 hidden">
                                    حذف
                                </button>
                                <button type="submit" id="modalSubmitBtn" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition-all flex items-center gap-2">
                                    <span id="submitBtnText">حفظ المنتج</span>
                                    <div class="loading-spinner w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal (Same as separate pages) -->
<div id="category-modal" class="fixed inset-0 hidden" style="z-index: 200000;">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCategoryModal()"></div>
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl" style="z-index: 200001;">
        <div class="flex items-center justify-between mb-4 border-b border-slate-100 pb-3">
            <h2 class="text-base font-black text-slate-800">إضافة فئة جديدة</h2>
            <button onclick="closeCategoryModal()" class="text-slate-400 hover:text-slate-600 bg-slate-50 p-1.5 rounded-full transition-colors">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>

        <form id="addCategoryForm" class="space-y-4">
            <div class="form-group">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">الفئة الرئيسية</label>
                <select id="parent-category-select" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all" onchange="toggleNewParentInput(this.value)">
                    <option value="">-- اختر فئة رئيسية --</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                    {% if supplier.can_add_categories or user.is_superuser %}
                    <option value="new" class="font-bold text-blue-600">+ إضافة فئة رئيسية جديدة</option>
                    {% endif %}
                </select>
            </div>

            <div id="new-parent-container" class="form-group hidden">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">اسم الفئة الرئيسية الجديدة</label>
                <input type="text" id="new-parent-name" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm" placeholder="مثلاً: إلكترونيات">
            </div>

            <div class="form-group">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">اسم الفئة الفرعية</label>
                <input type="text" id="subcategory-name" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm" placeholder="مثلاً: هواتف ذكية">
            </div>

            <button type="button" onclick="submitCategory()" id="submitCategoryBtn" class="w-full py-3 bg-blue-500 text-white rounded-xl text-sm font-bold hover:bg-blue-600 hover:shadow-lg hover:shadow-blue-500/30 transition-all flex items-center justify-center gap-2 mt-2">
                <span>حفظ الفئة</span>
                <i class="fas fa-check"></i>
                <div class="loading-spinner w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
            </button>
        </form>
    </div>
</div>

<script>
    // Live Preview Sync (Simplified)
    document.getElementById('id_category')?.addEventListener('change', e => {
        const opt = e.target.options[e.target.selectedIndex];
        // Preview logic removed as we integrated it into uploaders
    });

    // Main Image Preview Update
    document.getElementById('id_image')?.addEventListener('change', async function(e) {
        if (this._isCompressing) return;
        await handleImageUpload(this);
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('modalPreviewImage').src = e.target.result;
                document.getElementById('modalFilePreview').classList.remove('hidden');
                document.getElementById('modalFileUploadContent').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Clear main image logic
    document.getElementById('clearFileBtn')?.addEventListener('click', function() {
        document.getElementById('id_image').value = '';
        document.getElementById('modalFilePreview').classList.add('hidden');
        document.getElementById('modalFileUploadContent').classList.remove('hidden');
    });

    // Video Preview
    document.getElementById('id_video')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('modalVideoPreview').classList.remove('hidden');
            document.getElementById('modalVideoUploadContent').classList.add('hidden');
        }
    });

    // Additional Images Preview
    document.getElementById('id_additional_images')?.addEventListener('change', async function(e) {
        if (this._isCompressing) return;
        await handleImageUpload(this);
        const files = e.target.files;
        const countBadge = document.getElementById('additional-images-count');
        
        if (files && files.length > 0) {
            countBadge.textContent = files.length;
            countBadge.classList.remove('hidden');
        } else {
            countBadge.classList.add('hidden');
        }
    });
</script>
