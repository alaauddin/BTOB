{% load static %}

<!-- Unified Product Modal -->
<div id="product-modal" class="fixed inset-0 hidden" style="z-index: 99999;">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeProductModal()"></div>
    <div class="fixed inset-0 overflow-y-auto" style="z-index: 100000;">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-right shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-white/20">
                
                <!-- Modal Header -->
                <div class="flex items-center justify-between border-b border-slate-100 p-4 bg-white/80 backdrop-blur-md sticky top-0 z-10">
                    <h3 class="text-lg font-black text-slate-800" id="modal-title">إضافة منتج جديد</h3>
                    <button onclick="closeProductModal()" class="rounded-full p-2 text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <style>
                    /* Ultra-compact overrides for modal form fields */
                    #productForm input[type="text"], 
                    #productForm input[type="number"], 
                    #productForm select,
                    #productForm textarea,
                    .form-input {
                        padding: 0.35rem 0.5rem !important;
                        font-size: 0.7rem !important;
                        border-radius: 0.5rem !important;
                        height: auto !important;
                        min-height: unset !important;
                    }
                    #productForm label.form-label, 
                    #addCategoryForm label.form-label {
                        font-size: 0.65rem !important;
                        margin-bottom: 0.2rem !important;
                    }
                    /* Compact placeholder styling */
                    #productForm ::placeholder {
                        font-size: 0.65rem !important;
                    }
                    /* Category modal inputs */
                    #addCategoryForm input, #addCategoryForm select {
                        padding: 0.35rem 0.5rem !important;
                        font-size: 0.7rem !important;
                    }
                </style>

                <div class="editor-container grid grid-cols-1 lg:grid-cols-[1fr_1.5fr] gap-3 p-4 bg-slate-50/50">
                    <!-- Left Side: Product Preview -->
                    <div class="preview-card glass-card h-fit sticky top-4">
                        <div class="product-preview-box text-center p-3 bg-white rounded-xl shadow-sm border border-slate-100">
                            <h2 class="text-[9px] font-bold text-blue-600 uppercase tracking-widest mb-2">معاينة</h2>
          
                            <div class="space-y-1">
                                <h3 id="preview-display-name" class="text-sm font-black text-slate-800 line-clamp-1">اسم المنتج</h3>
                                <div class="flex items-center justify-center gap-1">
                                    <span id="preview-display-price" class="text-base font-bold text-blue-600">0.00</span>
                                    <span class="text-[9px] font-semibold text-slate-500">{{ supplier.currency }}</span>
                                </div>
                                <div id="preview-display-category" class="inline-block px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full text-[9px] font-bold">
                                    الفئة
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Form Content -->
                    <form id="productForm" method="post" enctype="multipart/form-data" novalidate class="flex flex-col gap-3">
                        {% csrf_token %}
                        <input type="hidden" id="edit-product-id" name="product_id">
                        <input type="hidden" name="supplier_id" value="{{ supplier.id }}">
                        
                        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 space-y-2">
                            <!-- Name -->
                            <div class="form-group">
                                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                    <i class="fas fa-tag text-blue-500 ml-1"></i>
                                    {{ product_form.name.label }}
                                </label>
                                {{ product_form.name }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="name-error"></div>
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                    <i class="fas fa-align-left text-blue-500 ml-1"></i>
                                    {{ product_form.description.label }}
                                </label>
                                {{ product_form.description }}
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="description-error"></div>
                            </div>

                            <!-- Main Image -->
                            <div class="form-group">
                                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                    <i class="fas fa-image text-blue-500 ml-1"></i>
                                    {{ product_form.image.label }}
                                </label>
                                <div class="file-input-wrapper relative border-2 border-dashed border-slate-200 rounded-xl p-3 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer group" id="modalFileWrapper">
                                    <input type="file" name="image" id="id_image" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*">
                                    <div id="modalFileUploadContent" class="pointer-events-none transition-opacity">
                                        <i class="fas fa-cloud-upload-alt text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[9px] text-slate-500">اختر صورة المنتج الرئيسية</p>
                                    </div>
                                    <div id="modalFilePreview" class="hidden flex items-center justify-between gap-2 text-right bg-white p-2 rounded-lg shadow-sm border border-slate-100 absolute inset-1 z-20">
                                        <div class="flex items-center gap-2 overflow-hidden">
                                            <img id="modalPreviewImage" src="" class="w-8 h-8 rounded object-cover">
                                            <span id="modalFileName" class="text-[9px] font-bold text-slate-700 truncate"></span>
                                        </div>
                                        <button type="button" id="clearFileBtn" class="text-red-400 hover:text-red-500 p-1">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="image-error"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Price -->
                                <div class="form-group">
                                    <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                        <i class="fas fa-coins text-blue-500 ml-1"></i>
                                        {{ product_form.price.label }}
                                    </label>
                                    {{ product_form.price }}
                                    <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="price-error"></div>
                                </div>

                                <!-- Category -->
                                <div class="form-group">
                                    <div class="flex justify-between items-center mb-1.5">
                                        <label class="form-label text-xs font-bold text-slate-600 block mb-0">
                                            <i class="fas fa-layer-group text-blue-500 ml-1"></i>
                                            {{ product_form.category.label }}
                                        </label>
                                        {% if supplier.can_add_product_categories or user.is_superuser %}
                                        <button type="button" onclick="openCategoryModal()" class="text-[9px] font-bold text-blue-600 hover:text-blue-700 bg-blue-50 px-2 py-0.5 rounded-full transition-colors">
                                            <i class="fas fa-plus-circle"></i> جديد
                                        </button>
                                        {% endif %}
                                    </div>
                                    {{ product_form.category }}
                                    <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="category-error"></div>
                                </div>
                            </div>

                            <!-- Video Upload -->
                            <div class="form-group">
                                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                    <i class="fas fa-video text-blue-500 ml-1"></i>
                                    {{ product_form.video.label }}
                                </label>
                                <div class="file-input-wrapper relative border-2 border-dashed border-slate-200 rounded-xl p-3 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer group" id="modalVideoWrapper">
                                    <input type="file" name="video" id="id_video" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="video/*">
                                    <div id="modalVideoUploadContent" class="pointer-events-none transition-opacity">
                                        <i class="fas fa-film text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[9px] text-slate-500">اختر فيديو المنتج</p>
                                    </div>
                                    <div id="modalVideoPreview" class="hidden flex items-center gap-2 text-right bg-white p-2 rounded-lg shadow-sm border border-slate-100 absolute inset-1 z-20">
                                        <i class="fas fa-video text-blue-500"></i>
                                        <span id="modalVideoName" class="text-[9px] font-bold text-slate-700 truncate"></span>
                                    </div>
                                </div>
                                <div class="error-message text-red-500 text-[10px] mt-1 hidden" id="video-error"></div>
                            </div>

                            <!-- Additional Images -->
                            <div class="form-group">
                                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">
                                    <i class="fas fa-images text-blue-500 ml-1"></i>
                                    صور إضافية للمنتج
                                </label>
                                <div class="file-input-wrapper relative border-2 border-dashed border-slate-200 rounded-xl p-3 text-center hover:border-blue-400 hover:bg-blue-50/30 transition-all cursor-pointer group">
                                    <input type="file" name="additional_images" id="id_additional_images" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" multiple accept="image/*">
                                    <div class="pointer-events-none">
                                        <i class="fas fa-plus-square text-blue-400 text-lg mb-1 block"></i>
                                        <p class="text-[9px] text-slate-500">اختر صور إضافية</p>
                                    </div>
                                </div>
                                <div id="additional-images-preview" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>

                            <!-- Is New -->
                            <div class="form-group">
                                <label class="checkbox-wrapper flex items-center gap-2 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                                    {{ product_form.is_new }}
                                    <span class="text-[11px] font-bold text-slate-600">
                                        <i class="fas fa-star text-yellow-400 ml-1"></i>
                                        {{ product_form.is_new.label }}
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Sticky Actions -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeProductModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">
                                إلغاء
                            </button>
                            <!-- Delete Button (Hidden by default, shown in edit mode) -->
                            <button type="button" id="modalDeleteBtn" class="flex-1 py-3 bg-red-50 text-red-500 rounded-xl font-bold text-sm hover:bg-red-100 transition-colors hidden focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                <i class="fas fa-trash-alt ml-1"></i> حذف
                            </button>
                            <button type="submit" id="modalSubmitBtn" class="flex-[2] py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
                                <span id="submitBtnText">حفظ المنتج</span>
                                <div class="loading-spinner w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal (Same as separate pages) -->
<div id="category-modal" class="fixed inset-0 hidden" style="z-index: 200000;">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCategoryModal()"></div>
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl" style="z-index: 200001;">
        <div class="flex items-center justify-between mb-4 border-b border-slate-100 pb-3">
            <h2 class="text-base font-black text-slate-800">إضافة فئة جديدة</h2>
            <button onclick="closeCategoryModal()" class="text-slate-400 hover:text-slate-600 bg-slate-50 p-1.5 rounded-full transition-colors">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>

        <form id="addCategoryForm" class="space-y-4">
            <div class="form-group">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">الفئة الرئيسية</label>
                <select id="parent-category-select" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all" onchange="toggleNewParentInput(this.value)">
                    <option value="">-- اختر فئة رئيسية --</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                    {% if supplier.can_add_categories or user.is_superuser %}
                    <option value="new" class="font-bold text-blue-600">+ إضافة فئة رئيسية جديدة</option>
                    {% endif %}
                </select>
            </div>

            <div id="new-parent-container" class="form-group hidden">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">اسم الفئة الرئيسية الجديدة</label>
                <input type="text" id="new-parent-name" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm" placeholder="مثلاً: إلكترونيات">
            </div>

            <div class="form-group">
                <label class="form-label text-xs font-bold text-slate-600 mb-1.5 block">اسم الفئة الفرعية</label>
                <input type="text" id="subcategory-name" class="form-input w-full p-2.5 rounded-xl border border-slate-200 text-sm" placeholder="مثلاً: هواتف ذكية">
            </div>

            <button type="button" onclick="submitCategory()" id="submitCategoryBtn" class="w-full py-3 bg-blue-500 text-white rounded-xl text-sm font-bold hover:bg-blue-600 hover:shadow-lg hover:shadow-blue-500/30 transition-all flex items-center justify-center gap-2 mt-2">
                <span>حفظ الفئة</span>
                <i class="fas fa-check"></i>
                <div class="loading-spinner w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
            </button>
        </form>
    </div>
</div>

<script>
    // Preview for Main Image (already exists in some form but let's ensure it's there or updated)
    document.getElementById('id_image')?.addEventListener('change', async function(e) {
        if (this._isCompressing) return;
        await handleImageUpload(this);
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('modalPreviewImage').src = e.target.result;
                document.getElementById('modalFileName').textContent = file.name;
                document.getElementById('modalFilePreview').classList.remove('hidden');
                document.getElementById('modalFileUploadContent').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Preview for Video
    document.getElementById('id_video')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('modalVideoName').textContent = file.name;
            document.getElementById('modalVideoPreview').classList.remove('hidden');
            document.getElementById('modalVideoUploadContent').classList.add('hidden');
        }
    });

    // Preview for Additional Images
    document.getElementById('id_additional_images')?.addEventListener('change', async function(e) {
        if (this._isCompressing) return;
        await handleImageUpload(this);
        const files = e.target.files;
        const previewContainer = document.getElementById('additional-images-preview');
        previewContainer.innerHTML = '';
        
        if (files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-10 h-10 rounded-lg object-cover ring-2 ring-slate-100';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    });

    // Clear main image logic if not yet defined
    document.getElementById('clearFileBtn')?.addEventListener('click', function() {
        document.getElementById('id_image').value = '';
        document.getElementById('modalFilePreview').classList.add('hidden');
        document.getElementById('modalFileUploadContent').classList.remove('hidden');
    });
</script>
