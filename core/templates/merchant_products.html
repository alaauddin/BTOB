{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة المنتجات - {{ supplier.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/merchant_dashboard.css' %}?v={{ css_version }}">
<link rel="stylesheet" href="{% static 'css/merchant_products.css' %}?v={{ css_version }}">
<style>
    :root {
        --primary-color: {{ supplier.primary_color|default:'#F58231' }};
        --secondary-color: {{ supplier.secondary_color|default:'#ffffff' }};
        --accent-color: {{ supplier.accent_color|default:'#00FFFF' }};
    }

    /* Enhanced Table Responsiveness */
    .products-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 991px) {
        .products-table th:nth-child(2), /* Category */
        .products-table td:nth-child(2),
        .products-table th:nth-child(3), /* Rating */
        .products-table td:nth-child(3) {
            display: none !important;
        }
    }

    @media (max-width: 767px) {
        .products-table th:nth-child(4), /* Stock */
        .products-table td:nth-child(4) {
            display: none !important;
        }
        
        .product-row-name {
            font-size: 0.85rem;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thumbnail-sm {
            width: 36px;
            height: 36px;
        }

        .price-now {
            font-size: 0.9rem;
        }
        
        .price-badge-discount {
            font-size: 0.65rem;
            padding: 1px 4px;
        }

        .status-text {
            display: none;
        }

        .status-toggle-wrapper {
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .products-table th, .products-table td {
            padding: 0.75rem 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" dir="rtl">
    <div class="products-container">
        <!-- Breadcrumbs & Header -->
        <div class="breadcrumb-container">
            <ul class="breadcrumb-custom">
                <li class="breadcrumb-item-custom">
                    <a href="{% url 'my_merchant' %}{% if request.GET.supplier_id %}?supplier_id={{ request.GET.supplier_id }}{% endif %}">لوحة التحكم</a>
                </li>
                <i class="fas fa-chevron-left breadcrumb-separator"></i>
                <li class="breadcrumb-item-custom active">إدارة المنتجات </li>
            </ul>
        </div>

        <div class="page-title-row">
            <h2 class="page-title">
                <i class="fas fa-box"></i>
                إدارة المنتجات
            </h2>
            <button class="action-btn" onclick="openAddProductModal()">
                <i class="fas fa-plus"></i>
                <span>إضافة منتج جديد</span>
            </button>
        </div>

        <!-- Statistics Summary Row -->
        <div class="stats-summary-card">
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-number">{{ products.count }}</span>
                    <span class="stat-label">إجمالي المنتجات</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number text-emerald-600">{{ active_products_count }}</span>
                    <span class="stat-label">منتجات نشطة</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number text-slate-400">{{ inactive_products_count }}</span>
                    <span class="stat-label">منتجات مخفية</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number text-orange-500">{{ active_offers_count }}</span>
                    <span class="stat-label">عروض نشطة</span>
                </div>
            </div>
        </div>

        <!-- Innovative Filters -->
        <div class="filters-section">
            <div class="status-row-wrapper">
                <div class="status-tabs-container">
                    <div class="status-tab active" data-status="all" onclick="filterByStatus('all')">جميع المنتجات</div>
                    <div class="status-tab" data-status="active" onclick="filterByStatus('active')">نشط ({{ active_products_count }})</div>
                    <div class="status-tab" data-status="inactive" onclick="filterByStatus('inactive')">مخفي ({{ inactive_products_count }})</div>
                    <div class="status-tab" data-status="new" onclick="filterByStatus('new')">جديد</div>
                    <div class="status-tab" data-status="offered" onclick="filterByStatus('offered')">عليه عرض ({{ active_offers_count }})</div>
                </div>
                <button type="button" class="btn-toggle-filter" onclick="toggleFilters()" id="filterToggleBtn" title="بحث وتصنيف">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Collapsible Search and Category Row -->
            <div id="collapsibleFilters" class="collapsible-filter-content">
                <div class="compact-filter-row">
                    <div class="filter-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearch" placeholder="بحث باسم المنتج..." oninput="filterProducts()">
                    </div>
                    
                    <div class="filter-input-wrapper">
                        <i class="fas fa-filter"></i>
                        <select id="categoryFilter" onchange="filterProducts()">
                            <option value="">جميع الأقسام</option>
                            {% for cat in categories %}
                            <option value="{{ cat.name }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sub-Tabs Navigation (Hidden or Minimized in V2) -->
        <div class="tab-container hidden">
            <div class="flex flex-wrap justify-center border-b border-gray-100">
                <button class="tab-btn active" onclick="showSubTab('products')">المنتجات</button>
                <button class="tab-btn" onclick="showSubTab('offers')">العروض</button>
                <button class="tab-btn" onclick="showSubTab('promotions')">طلبات الترويج</button>
            </div>
        </div>

    <!-- Products Sub-Tab -->
    <div id="products-subtab" class="subtab-content">
        {% if products %}
            <div class="products-table-wrapper">
                <table class="products-table" id="mainProductsTable">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الفئة</th>
                            <th>التقييم</th>
                            <th>المخزون</th>
                            <th>السعر</th>
                            <th>الحالة</th>
                            <th class="text-left">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="mainProductGrid">
                        {% for product in products %}
                        <tr class="product-row animate-row" 
                            data-name="{{ product.name|lower }}" 
                            data-category="{{ product.category.name }}"
                            data-is-active="{{ product.is_active|yesno:'true,false' }}"
                            data-is-new="{{ product.is_new|yesno:'true,false' }}"
                            data-has-offer="{{ product.has_discount|yesno:'true,false' }}">
                            
                            <!-- Product Cell -->
                            <td>
                                <div class="product-cell-main">
                                    <img src="{{ product.image.url }}" class="thumbnail-sm" alt="{{ product.name }}">
                                    <div class="product-info-mini">
                                        <span class="product-row-name">{{ product.name }}</span>
                                        {% if product.is_new %}
                                        <span class="product-badge-new">جديد</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>

                            <!-- Category -->
                            <td class="product-row-cat">{{ product.category.name }}</td>

                            <!-- Rating -->
                            <td>
                                <div class="flex items-center gap-1 text-yellow-500">
                                    <i class="fas fa-star text-[10px]"></i>
                                    <span class="text-xs font-black">{{ product.get_average_rating|floatformat:1 }}</span>
                                </div>
                            </td>

                            <!-- Stock -->
                            <td>
                                <div class="flex flex-col items-center">
                                    <span class="text-xs font-bold {% if product.stock < 5 %}text-red-500{% else %}text-slate-600{% endif %}">
                                        {{ product.stock }}
                                    </span>
                                    {% if product.stock < 5 %}
                                    <span class="text-[8px] px-1 bg-red-50 text-red-500 rounded font-black">منخفض</span>
                                    {% endif %}
                                </div>
                            </td>

                            <!-- Price -->
                            <td>
                                <div class="price-container-row">
                                    <div class="price-now">
                                        {% if product.has_discount %}
                                            <span class="price-old text-gray-300 line-through text-[10px] ml-1">{{ product.price|floatformat:0 }} {{ supplier.currency.symbol }}</span>
                                            {{ product.get_price_with_offer|floatformat:0 }} {{ supplier.currency.symbol }}
                                        {% else %}
                                            {{ product.price|floatformat:0 }} {{ supplier.currency.symbol }}
                                        {% endif %}
                                        
                                    </div>
                                    {% if product.has_discount %}
                                    <span class="price-badge-discount">خصم {{ product.get_discount_precentage }}%</span>
                                    {% endif %}
                                </div>
                            </td>

                            <!-- Status Toggle -->
                            <td>
                                <div class="status-toggle-wrapper">
                                    <label class="toggle-switch">
                                        <input type="checkbox" {% if product.is_active %}checked{% endif %} 
                                               onchange="confirmToggleProductStatus({{ product.id }}, {{ product.is_active|yesno:'true,false' }})">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="status-text {% if product.is_active %}status-active{% else %}status-hidden{% endif %}">
                                        {{ product.is_active|yesno:'نشط,مخفي' }}
                                    </span>
                                </div>
                            </td>

                            <!-- Actions -->
                            <td>
                                <div class="row-actions">
                                    <button onclick="editProduct({{ product.id }})" class="btn-row-action" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="shareProduct({{ product.id }}, '{{ product.name|escapejs }}')" class="btn-row-action" title="مشاركة">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                    <button onclick="openAddOfferModal({{ product.id }})" class="btn-row-action" title="إضافة عرض">
                                        <i class="fas fa-tag"></i>
                                    </button>
                                    <button onclick="deleteProduct({{ product.id }})" class="btn-row-action btn-delete" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <!-- Mobile Action Dropdown -->
                                <div class="mobile-actions-dropdown">
                                    <button onclick="toggleRowDropdown(event)" class="btn-row-action">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu-row">
                                        <button onclick="editProduct({{ product.id }})" class="dropdown-item-row">
                                            <i class="fas fa-edit"></i> تعديل
                                        </button>
                                        <button onclick="shareProduct({{ product.id }}, '{{ product.name|escapejs }}')" class="dropdown-item-row">
                                            <i class="fas fa-share-alt"></i> مشاركة
                                        </button>
                                        <button onclick="openAddOfferModal({{ product.id }})" class="dropdown-item-row">
                                            <i class="fas fa-tag"></i> إضافة عرض
                                        </button>
                                        <button onclick="deleteProduct({{ product.id }})" class="dropdown-item-row text-red-500">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- No Results State -->
            <div id="noResults" class="hidden py-20 text-center">
                <div class="w-24 h-24 bg-slate-50 text-slate-200 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">لا توجد نتائج</h3>
                <p class="text-slate-500">جرب البحث بكلمة مختلفة أو تغيير القسم</p>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3 class="text-2xl font-bold text-gray-600 mb-4">لا توجد منتجات بعد</h3>
                <button class="action-btn" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i>
                    إضافة منتج الآن
                </button>
            </div>
        {% endif %}
    </div>

    <!-- Offers Sub-Tab (V3 Management List) -->
    <div id="offers-subtab" class="subtab-content hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">العروض والخصومات</h2>
        </div>

        {% if active_offers %}
            <div class="products-table-wrapper">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>السعر الحالي</th>
                            <th>الخصم</th>
                            <th>السعر بعد الخصم</th>
                            <th>الحالة</th>
                            <th class="text-left">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for offer in active_offers %}
                        <tr class="product-row animate-row">
                            <td>
                                <div class="product-cell-main">
                                    <img src="{{ offer.product.image.url }}" class="thumbnail-sm" alt="{{ offer.product.name }}">
                                    <div class="product-info-mini">
                                        <span class="product-row-name">{{ offer.product.name }}</span>
                                        <span class="product-row-cat text-[10px]">{{ offer.from_date|date:"Y/m/d" }} - {{ offer.to_date|date:"Y/m/d" }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="font-bold text-slate-500">{{ offer.product.price }}</td>
                            <td>
                                <span class="bg-red-50 text-red-500 px-2 py-1 rounded-lg font-black text-xs border border-red-100">
                                    {{ offer.get_discount_percentage_offer|floatformat:0 }}%
                                </span>
                            </td>
                            <td class="font-black text-slate-800">{{ offer.get_price_with_discount|floatformat:2 }}</td>
                            <td>
                                <span class="status-text {% if offer.is_active %}status-active{% else %}status-hidden{% endif %}">
                                    {{ offer.is_active|yesno:'نشط,معطل' }}
                                </span>
                            </td>
                            <td>
                                <div class="row-actions">
                                    <button onclick="editOffer({{ offer.id }})" class="btn-row-action" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <!-- Mobile Action Dropdown -->
                                <div class="mobile-actions-dropdown">
                                    <button onclick="toggleRowDropdown(event)" class="btn-row-action">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu-row">
                                        <button onclick="editOffer({{ offer.id }})" class="dropdown-item-row">
                                            <i class="fas fa-edit"></i> تعديل
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-tag"></i>
                <h3 class="text-2xl font-bold text-gray-600 mb-4">لا توجد عروض نشطة</h3>
            </div>
        {% endif %}
    </div>

    <!-- Promotions Sub-Tab (V3 Management List) -->
    <div id="promotions-subtab" class="subtab-content hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <div>
                <h2 class="text-xl font-black text-slate-800 mb-1">طلبات الترويج</h2>
                <p class="text-slate-500 text-sm">إدارة مبيعاتك في قسم العروض الرئيسية.</p>
            </div>
            <button onclick="openPromotionModal()" class="w-full sm:w-auto px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-2xl font-bold flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i>
                طلب ترويج جديد
            </button>
        </div>

        {% if platform_promotions %}
            <div class="products-table-wrapper">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>التاريخ</th>
                            <th>الحالة</th>
                            <th class="text-left">الوصف</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for promo in platform_promotions %}
                        <tr class="product-row animate-row">
                            <td>
                                <div class="product-cell-main">
                                    <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400">
                                        <i class="fas fa-bullhorn"></i>
                                    </div>
                                    <div class="product-info-mini">
                                        <span class="product-row-name">{{ promo.product.name }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-xs text-slate-500 font-bold">
                                {{ promo.start_date|date:"Y/m/d" }} - {{ promo.end_date|date:"Y/m/d" }}
                            </td>
                            <td>
                                {% if promo.is_approved %}
                                <span class="px-2 py-1 bg-green-50 text-green-600 text-[10px] font-black rounded-lg border border-green-100">مقبول</span>
                                {% else %}
                                <span class="px-2 py-1 bg-orange-50 text-orange-600 text-[10px] font-black rounded-lg border border-orange-100">قيد المعالجة</span>
                                {% endif %}
                            </td>
                            <td class="text-xs text-slate-500 max-w-xs truncate">{{ promo.description }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-bullhorn"></i>
                <h3 class="text-2xl font-bold text-gray-600 mb-4">لا توجد طلبات ترويج</h3>
            </div>
        {% endif %}
    </div>
</div>

{% include 'product_modal_snippet.html' %}
{% include 'promotion_modal_snippet.html' %}

<script>
    window.merchantConfig = {
        supplierId: '{{ supplier.id }}',
        storeId: '{{ supplier.store_id }}',
        host: '{{ request.scheme }}://{{ request.get_host }}',
        addCategoryAjaxUrl: "{% url 'add_category_ajax' %}",
        csrfToken: '{{ csrf_token }}',
        addProductUrl: "{% url 'add_product' %}"
    };
</script>
<script src="{% static 'js/merchant_products.js' %}?v={{css_version}}"></script>

{% if not has_seen_products_tour %}
<!-- Product Tour — First-Time User Experience -->
<link rel="stylesheet" href="{% static 'css/product_tour.css' %}?v={{ css_version }}">
<script src="{% static 'js/product_tour.js' %}?v={{ css_version }}"></script>
{% endif %}

<!-- Note: We should ideally move common product management scripts to a separate file, 
     but for now, I will ensure they are available in this template. -->
{% endblock %}

{% block footer %}
<!-- Premium Compact Merchant Footer -->
<footer class="merchant-footer">
    <div class="container mx-auto px-6">
        <div class="merchant-footer-content">
            <div class="merchant-footer-links">
                <a href="#">من نحن</a>
                <a href="#">الشروط والأحكام</a>
                <a href="{% url 'privacy_policy' %}">سياسة الخصوصية</a>
            </div>
            
            <div class="merchant-footer-info">
                <span>© {% now "Y" %} {{ system_settings.site_name }}</span>
                {% if supplier.profile_picture %}
                    <img src="{{ supplier.profile_picture.url }}" alt="{{ supplier.name }}" class="merchant-footer-logo">
                {% endif %}
                <span>جميع الحقوق محفوظة</span>
            </div>
        </div>
    </div>
</footer>
{% endblock %}
