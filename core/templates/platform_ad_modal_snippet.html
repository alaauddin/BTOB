<!-- Platform Ad Modal -->
<div id="platform-ad-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closePlatformAdModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-right shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100">
                
                <!-- Modal Header -->
                <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse justify-between items-center border-b border-gray-100">
                    <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none transition-colors" onclick="closePlatformAdModal()">
                        <span class="sr-only">إغلاق</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2" id="platform-ad-modal-title">
                        <span class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                            <i class="fas fa-bullhorn text-sm"></i>
                        </span>
                        <span>إضافة إعلان منصة جديد</span>
                    </h3>
                </div>

                <!-- Modal Body -->
                <form id="platformAdForm" onsubmit="handlePlatformAdSubmit(event)" enctype="multipart/form-data">
                    <div class="px-6 py-6 space-y-5">
                        <input type="hidden" name="supplier_id" value="{{ supplier.id }}">
                        <input type="hidden" id="edit-platform-ad-id" name="ad_id">

                        <!-- Image Upload -->
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">
                                صورة الإعلان (بانر) <span class="text-red-500">*</span>
                            </label>
                            
                            <div class="relative group">
                                <!-- Preview Area -->
                                <div id="platform-ad-preview-container" class="hidden relative rounded-xl overflow-hidden border-2 border-gray-200 aspect-[3/1] bg-gray-50">
                                    <img id="platform-ad-image-preview" src="" alt="Preview" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                        <button type="button" onclick="triggerPlatformAdImageUpload()" class="p-2 bg-white/20 hover:bg-white/30 text-white rounded-lg backdrop-blur-sm transition-colors">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                    </div>
                                    <button type="button" id="clearPlatformAdImage" onclick="clearPlatformAdImagePreview()" class="absolute top-2 left-2 p-1.5 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 transition-colors z-20" title="حذف الصورة">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>

                                <!-- Upload Area -->
                                <div id="platform-ad-upload-content" class="w-full">
                                    <label for="id_platform_image" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-purple-50 hover:border-purple-300 transition-all group-hover:border-purple-400">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <div class="w-10 h-10 mb-3 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-purple-500 transition-colors">
                                                <i class="fas fa-cloud-upload-alt text-xl"></i>
                                            </div>
                                            <p class="mb-1 text-sm text-gray-500 group-hover:text-purple-600"><span class="font-semibold">اضغط للرفع</span> أو اسحب وأفلت</p>
                                            <p class="text-xs text-gray-400">PNG, JPG, GIF (Max 5MB)</p>
                                        </div>
                                        <input id="id_platform_image" name="image" type="file" class="hidden" accept="image/*" onchange="previewPlatformAdImage(this)">
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-gray-100 rounded-b-2xl">
                        <button type="submit" id="savePlatformAdBtn" class="flex-1 inline-flex justify-center items-center gap-2 rounded-xl border border-transparent bg-purple-600 px-4 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all">
                            <i class="fas fa-save"></i>
                            <span>حفظ الإعلان</span>
                        </button>
                        <button type="button" class="flex-1 inline-flex justify-center items-center gap-2 rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all" onclick="closePlatformAdModal()">
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openAddPlatformAdModal() {
        if (typeof resetPlatformAdModal === 'function') resetPlatformAdModal();
        document.getElementById('platform-ad-modal').classList.remove('hidden');
    }

    function closePlatformAdModal() {
        document.getElementById('platform-ad-modal').classList.add('hidden');
        resetPlatformAdModal();
    }

    function resetPlatformAdModal() {
        document.getElementById('platformAdForm').reset();
        document.getElementById('edit-platform-ad-id').value = '';
        document.getElementById('platform-ad-preview-container').classList.add('hidden');
        document.getElementById('platform-ad-upload-content').classList.remove('hidden');
        document.getElementById('platform-ad-image-preview').src = '';
        document.getElementById('platform-ad-modal-title').innerHTML = `
            <span class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-bullhorn text-sm"></i>
            </span>
            <span>إضافة إعلان منصة جديد</span>
        `;
    }

    function triggerPlatformAdImageUpload() {
        document.getElementById('id_platform_image').click();
    }

    function previewPlatformAdImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('platform-ad-image-preview').src = e.target.result;
                document.getElementById('platform-ad-preview-container').classList.remove('hidden');
                document.getElementById('platform-ad-upload-content').classList.add('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearPlatformAdImagePreview() {
        const input = document.getElementById('id_platform_image');
        input.value = '';
        document.getElementById('platform-ad-image-preview').src = '';
        document.getElementById('platform-ad-preview-container').classList.add('hidden');
        document.getElementById('platform-ad-upload-content').classList.remove('hidden');
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const maxWidth = 1920;
            const maxHeight = 1920; // Allow square or portrait too, just limit max dimension
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize if larger than max dimensions
                    if (width > maxWidth || height > maxHeight) {
                        if (width > height) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        } else {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Use JPEG for non-transparent images to save space, keep PNG if it was PNG
                    // But if it was huge PNG, maybe user wants it smaller. 
                    // Let's stick to original type but if it is capable of lossy compression (jpeg/webp), use 0.7 quality.
                    let type = file.type;
                    let quality = 0.7;
                    
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            reject(new Error('Canvas is empty'));
                            return;
                        }
                        const newFile = new File([blob], file.name, {
                            type: type,
                            lastModified: Date.now()
                        });
                        resolve(newFile);
                    }, type, quality);
                }
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    }

    async function handlePlatformAdSubmit(event) {
        event.preventDefault();
        const form = event.target;
        
        const btn = document.getElementById('savePlatformAdBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-compress fa-pulse"></i> جاري تهيئة الصورة...';
        btn.disabled = true;

        const formData = new FormData(form);
        const fileInput = document.getElementById('id_platform_image');

        // Compress image if selected
        if (fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                // Only compress if image is > 1MB to avoid processing small images unnecessarily
                if (file.size > 1024 * 1024) {
                    const compressedFile = await compressImage(file);
                    formData.set('image', compressedFile, compressedFile.name);
                    console.log(`Original: ${(file.size/1024/1024).toFixed(2)}MB, Compressed: ${(compressedFile.size/1024/1024).toFixed(2)}MB`);
                }
            } catch (e) {
                console.error("Compression failed:", e);
                // Continue with original file if compression fails
            }
        }
        
        const supplierParam = new URLSearchParams(window.location.search).get('supplier_id');
        const url = (adId ? `/edit-platform-ad/${adId}/` : '/add-platform-ad/') + (supplierParam ? `?supplier_id=${supplierParam}` : '');
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                closePlatformAdModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                let msg = data.message;
                if (data.errors) {
                    msg += ': ' + Object.values(data.errors).join(', ');
                }
                showNotification(msg, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showNotification('حدث خطأ غير متوقع', 'error');
        })
        .finally(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
    }

    function editPlatformAd(adId, btn) {
        // Fetch ad details and populate form
        const icon = btn.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'fas fa-spinner fa-spin';

        const supplierParam = new URLSearchParams(window.location.search).get('supplier_id');
        const url = `/edit-platform-ad/${adId}/` + (supplierParam ? `?supplier_id=${supplierParam}` : '');

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const ad = data.ad;
                resetPlatformAdModal(); // Clear previous state
                
                document.getElementById('edit-platform-ad-id').value = ad.id;
                
                if (ad.image_url) {
                     document.getElementById('platform-ad-image-preview').src = ad.image_url;
                     document.getElementById('platform-ad-preview-container').classList.remove('hidden');
                     document.getElementById('platform-ad-upload-content').classList.add('hidden');
                }

                document.getElementById('platform-ad-modal-title').innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                        <i class="fas fa-edit text-sm"></i>
                    </span>
                    <span>تعديل إعلان المنصة</span>
                `;
                
                document.getElementById('platform-ad-modal').classList.remove('hidden');
            } else {
                showNotification(data.message || 'Error fetching ad', 'error');
            }
        })
        .catch(err => showNotification('Error connecting to server', 'error'))
        .finally(() => icon.className = originalClass);
    }
    
    function confirmTogglePlatformAdStatus(adId, isActive) {
        Swal.fire({
            title: isActive ? 'تعطيل الإعلان؟' : 'تنشيط الإعلان؟',
            text: isActive ? "لن يظهر هذا الإعلان في المنصة." : "سيظهر هذا الإعلان في المنصة.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: isActive ? 'نعم، تعطيل' : 'نعم، تنشيط',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: isActive ? '#ef4444' : '#10b981',
        }).then((result) => {
            if (result.isConfirmed) {
                togglePlatformAdStatus(adId);
            } else {
                // Revert visual toggle if needed (usually handled by reload)
                location.reload(); 
            }
        });
    }

    function togglePlatformAdStatus(adId) {
        const supplierParam = new URLSearchParams(window.location.search).get('supplier_id');
        const url = `/toggle-platform-ad-status/${adId}/` + (supplierParam ? `?supplier_id=${supplierParam}` : '');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
             if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 800);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(err => showNotification('Error connecting to server', 'error'));
    }
</script>
