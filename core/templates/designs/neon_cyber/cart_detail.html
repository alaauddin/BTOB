{% extends 'designs/neon_cyber/base_neon.html' %}
{% load static %}
{% load cart_filters %}

{% block title %}حالة التخزين | سلة السايبر{% endblock %}

{% block neon_extra_css %}
<style>
    .cyber-cart-item {
        border-left: 5px solid var(--neon-cyan);
        padding: 1.5rem;
        margin-bottom: 2rem;
        background: rgba(0, 243, 255, 0.02);
        transition: 0.3s;
    }
    .cyber-cart-item.removed { opacity: 0; transform: skewX(-20deg); }
    .cart-img-cyber {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 1px solid var(--cyber-border);
    }
    .neon-input {
        background: #000 !important;
        border: 1px solid var(--neon-cyan) !important;
        color: var(--neon-cyan) !important;
        font-family: 'Orbitron', sans-serif;
        padding: 12px !important;
    }
    .neon-input::placeholder { color: var(--neon-cyan); opacity: 0.3; }

    /* Modal */
    .cyber-modal {
        background: #000;
        border: 2px solid var(--neon-magenta);
        color: white;
    }
    .neon-select-node {
        border: 1px solid var(--cyber-border);
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
    }
    .neon-select-node.active {
        border-color: var(--neon-magenta);
        box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        color: var(--neon-magenta);
    }
    
    #cyber-map {
        height: 300px;
        border: 1px solid var(--neon-cyan);
        margin-bottom: 2rem;
    }
    .cyber-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--neon-cyan);
        color: #000;
        padding: 10px 25px;
        font-family: 'Orbitron', sans-serif;
        z-index: 2000;
        display: none;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block neon_content %}
<div class="container py-5">
    <div class="cyber-font glow-cyan mb-4">// بيان_حالة_التخزين</div>
    
    {% if cart.cart_items.all %}
    <div class="row">
        <div class="col-lg-8">
            {% for item in cart.cart_items.all %}
            <div class="cyber-cart-item cyber-card" id="row-{{ item.id }}">
                <div class="d-flex align-items-center gap-4">
                    <img src="{{ item.product.image.url }}" class="cart-img-cyber" alt="">
                    <div class="flex-grow-1">
                        <div class="text-3 small font-monospace">NODE_{{ item.product.id }}</div>
                        <h4 class="mb-1 text-white">{{ item.product.name|upper }}</h4>
                        <div class="glow-cyan">{{ item.product.get_price_with_offer }} CR</div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="cyber-card d-flex align-items-center gap-3 py-1 px-3">
                            <button class="bg-transparent border-0 text-cyan p-0" onclick="decreaseQuantity('{{ item.id }}', '{{ supplier.store_id }}')">_نقص</button>
                            <span id="qty-{{ id }}" class="glow-cyan font-weight-bold">{{ item.quantity }}</span>
                            <button class="bg-transparent border-0 text-cyan p-0" onclick="increaseQuantity('{{ item.id }}', '{{ supplier.store_id }}')">_زيادة</button>
                        </div>
                        <button class="text-magenta bg-transparent border-0 font-monospace" onclick="removeItem('{{ item.id }}', '{{ supplier.store_id }}')">
                            [حذف]
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="col-lg-4">
            <div class="cyber-card p-4" style="border-color: var(--neon-magenta);">
                <h3 class="glow-magenta h4 mb-4">إجمالي_البيان</h3>
                <div class="d-flex justify-content-between mb-3 font-monospace text-3">
                    <span>قيمة_الأصول</span>
                    <span>{{ cart.get_total_amount }}</span>
                </div>
                <div class="d-flex justify-content-between mb-4 h3 glow-magenta">
                    <span>الرصيد_الصافي</span>
                    <span id="total-amount">{{ cart.get_total_after_discount }} {{ supplier.currency }}</span>
                </div>
                <button class="btn-cyber w-100 py-3 mb-3" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                    تنفيذ_الحيازة
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 cyber-card">
        <p class="text-3 font-monospace mb-4">> المخزن_فارغ: لم يتم اكتشاف أصول</p>
        <a href="{% url 'product-list' supplier.store_id %}" class="btn-cyber px-5">مسح_النظام_للسوق</a>
    </div>
    {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content cyber-modal">
            <div class="modal-body p-5">
                <div class="glow-magenta font-monospace mb-4">// رابط_الوجهة</div>
                
                <div class="row g-3 mb-5">
                    <div class="col-6">
                        <input type="radio" name="addr" id="sAddr" class="d-none" checked>
                        <label for="sAddr" class="neon-select-node active" id="sLabel">عنوان_النظام_01</label>
                    </div>
                    <div class="col-6">
                        <input type="radio" name="addr" id="nAddr" class="d-none">
                        <label for="nAddr" class="neon-select-node" id="nLabel">رابط_عقدة_جديد</label>
                    </div>
                </div>

                <div id="sSec">
                    {% if user_address %}
                    <div class="cyber-card p-3 mb-4 font-monospace text-cyan small">
                        >> المسار المسجل: {{ user_address.address_line1 }}
                    </div>
                    <button class="btn-cyber w-100" onclick="confirmExisting()">تأكيد_الوجهة</button>
                    {% else %}
                    <p class="text-3 font-monospace">خطأ: لم يتم تسجيل وجهة</p>
                    {% endif %}
                </div>

                <div id="nSec" style="display: none;">
                    <form id="nForm">
                        <div id="cyber-map"></div>
                        <input type="text" name="full_name" class="neon-input w-100 mb-3" placeholder="اسم_المعرف">
                        <input type="text" name="address_line1" class="neon-input w-100 mb-3" id="cyber-loc" placeholder="وصف_الإحداثيات">
                        <input type="text" name="phone" class="neon-input w-100 mb-3" placeholder="قناة_الإشارة">
                        <input type="hidden" name="lat" id="c-lat">
                        <input type="hidden" name="lng" id="c-lng">
                        <button type="submit" class="btn-cyber w-100 mt-3">إرسال_البيانات</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="cyber-toast" id="cyberToast">تم تحديث النظام</div>
{% endblock %}

{% block neon_extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    function showToast(m) { const t=document.getElementById('cyberToast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }

    function increaseQuantity(id, sid) {
        fetch(`/increase_quantity/${id}/${sid}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })
        .then(r=>r.json()).then(d=>{ if(d.success){ document.getElementById(`qty-${id}`).textContent=d.new_quantity; document.getElementById('total-amount').textContent=Math.floor(d.cart_total)+' CR'; showToast("BUFFER_ENHANCED"); }});
    }

    function decreaseQuantity(id, sid) {
        fetch(`/decrease_quantity/${id}/${sid}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })
        .then(r=>r.json()).then(d=>{ if(d.success){ if(d.new_quantity===0) location.reload(); else {document.getElementById(`qty-${id}`).textContent=d.new_quantity; document.getElementById('total-amount').textContent=Math.floor(d.cart_total)+' CR'; showToast("BUFFER_REDUCED");}}});
    }

    function removeItem(id, sid) {
        fetch(`/remove_item/${id}/${sid}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })
        .then(r=>r.json()).then(d=>{ if(d.success) location.reload(); });
    }

    document.getElementById('sAddr')?.addEventListener('change', () => {
        document.getElementById('sSec').style.display='block'; document.getElementById('nSec').style.display='none';
        document.getElementById('sLabel').classList.add('active'); document.getElementById('nLabel').classList.remove('active');
    });
    document.getElementById('nAddr')?.addEventListener('change', () => {
        document.getElementById('sSec').style.display='none'; document.getElementById('nSec').style.display='block';
        document.getElementById('nLabel').classList.add('active'); document.getElementById('sLabel').classList.remove('active');
        initMap();
    });

    let map, marker;
    function initMap() { if(map) return; map=L.map('cyber-map').setView([15.3,44.2],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); marker=L.marker([15.3,44.2],{draggable:true}).addTo(map); marker.on('dragend', updateCyberAddr); map.on('click', e=>{marker.setLatLng(e.latlng); updateCyberAddr();}); }
    function updateCyberAddr() { const ll=marker.getLatLng(); document.getElementById('c-lat').value=ll.lat; document.getElementById('c-lng').value=ll.lng; fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll.lat}&lon=${ll.lng}`).then(r=>r.json()).then(d=>document.getElementById('cyber-loc').value=d.display_name); }

    function confirmExisting() { fetch(`/checkout/{{ supplier.store_id }}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'}, body: JSON.stringify({address_option: 'saved'}) }).then(r=>r.json()).then(d=>{ if(d.success) location.href=d.redirect_url; }); }
</script>
{% endblock %}
